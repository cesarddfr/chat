<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Chat P2P ‚Äî Amigos, Admin y Videollamada</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{--bg:#f4f6fb;--panel:#fff;--muted:#6b7280;--accent:#2563eb;--danger:#ef4444}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  .app{display:grid;grid-template-columns:320px 1fr;gap:12px;height:100vh;padding:12px;background:var(--bg);box-sizing:border-box}
  .sidebar{background:var(--panel);border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(2,6,23,0.06);display:flex;flex-direction:column}
  .sidebar h3{margin:0 0 8px 0;font-size:16px}
  .sidebar .info{font-size:13px;color:var(--muted);margin-bottom:8px}
  #usersList{overflow:auto;flex:1;padding-right:6px}
  .user-row{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;margin-bottom:6px;transition:background .12s}
  .user-row:hover{background:#f1f5f9}
  .user-meta{display:flex;gap:8px;align-items:center;min-width:0}
  .avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff}
  .u-name{font-weight:600;font-size:14px;white-space:nowrap;text-overflow:ellipsis;overflow:hidden}
  .u-id{font-size:12px;color:var(--muted);max-width:110px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .user-actions{display:flex;gap:6px}
  .btn{padding:6px 8px;border-radius:8px;border:none;cursor:pointer;background:#eef2ff}
  .btn.small{padding:4px 6px;font-size:13px}
  .btn.kick{background:var(--danger);color:white}
  .main{display:flex;flex-direction:column;gap:10px}
  .top{display:flex;justify-content:space-between;gap:12px;align-items:center}
  .panel{background:var(--panel);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
  .chat-wrap{display:flex;gap:12px;height:calc(100vh - 200px)}
  .chat{flex:1;display:flex;flex-direction:column}
  #messages{flex:1;overflow:auto;padding:12px;border-radius:8px;border:1px solid #edf2f7;background:linear-gradient(180deg,#fff,#fbfdff)}
  .message{margin:6px 0;padding:8px 10px;border-radius:8px;max-width:75%}
  .msg-me{background:#e6f0ff;align-self:flex-end}
  .msg-other{background:#f3f4f6;align-self:flex-start}
  .meta{font-size:11px;color:var(--muted);margin-bottom:4px}
  .controls{display:flex;gap:8px;align-items:center;margin-top:8px}
  input[type='text']{padding:10px;border-radius:8px;border:1px solid #e6eef8;flex:1}
  #videos{display:flex;gap:12px;flex-wrap:wrap;padding:8px;border-radius:8px;border:1px dashed #e6eef8;min-height:140px;background:linear-gradient(180deg,#fff,#fbfdff)}
  .video-container{position:relative;width:260px;height:190px;border-radius:8px;overflow:hidden;background:black;display:flex;align-items:center;justify-content:center}
  .video-container video{width:100%;height:100%;object-fit:cover}
  .video-label{position:absolute;bottom:6px;left:6px;background:rgba(0,0,0,.5);color:white;font-size:12px;padding:4px 6px;border-radius:6px}
  .video-kick{position:absolute;top:6px;right:6px;display:none}
  .video-container.admin .video-kick{display:block}
  #adminPanel{display:none;position:absolute;top:20%;left:50%;transform:translateX(-50%);background:#fff;padding:20px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,.2);z-index:1000}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar panel">
    <h3>Amigos conectados</h3>
    <div class="info" id="sidebarInfo">Conectando...</div>
    <div id="usersList"></div>
    <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
      <input id="friendInput" type="text" placeholder="Apodo amigo" style="flex:1;padding:6px;border-radius:6px;border:1px solid #ccc">
      <button id="connectFriend" class="btn small">üí¨ Conectar</button>
    </div>
    <div style="margin-top:12px;font-size:13px;color:var(--muted)"><div><strong>Tu nombre:</strong> <span id="meName"></span></div><div style="margin-top:6px"><strong>ID:</strong> <span id="meId"></span></div></div>
  </aside>
  <main class="main">
    <div class="top">
      <h2 style="margin:0">Chat P2P ‚Äî Moderaci√≥n y Videollamada</h2>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="inviteAll" class="btn small">üìû Invitar a llamada</button>
      </div>
    </div>
    <div class="panel chat-wrap">
      <section class="chat panel" style="flex:1 1 60%">
        <div id="messages" aria-live="polite"></div>
        <div class="controls">
          <input id="messageInput" type="text" placeholder="Escribe un mensaje..." />
          <button id="sendBtn" class="btn">Enviar</button>
          <label class="btn small">üìÅ<input id="fileInput" type="file" style="display:none"></label>
        </div>
      </section>
      <aside style="width:420px;display:flex;flex-direction:column;gap:8px">
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center"><strong>Videollamadas</strong><span class="meta">Activas: <span id="activeCalls">0</span></span></div>
          <div id="videos"></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="startCam" class="btn small">Iniciar c√°mara</button>
            <button id="stopCam" class="btn small">Detener c√°mara</button>
            <button id="hangupAll" class="btn small">Colgar todo</button>
          </div>
        </div>
      </aside>
    </div>
  </main>
</div>

<div id="adminPanel">
  <h3>Panel Admin</h3>
  <div id="adminList"></div>
  <button id="closeAdmin" class="btn small">Cerrar</button>
</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
/* -------------------- Configuraci√≥n inicial -------------------- */
let userName='', myId='';
let peer=null, dataConns={}, mediaCalls={}, localStream=null;
let knownPeers=new Set(), banList={}, ipBanList={};

function askName(){
  userName = prompt('Elige tu apodo:')||'ChatUser'+Math.floor(Math.random()*1000);
  if(userName.startsWith('ChatUser')) askName();
  myId='chat-'+userName;
  meName.textContent=userName;
  meId.textContent=myId;
}
askName();

peer = new Peer(myId);

/* -------------------- UI Referencias -------------------- */
const usersList=document.getElementById('usersList');
const sidebarInfo=document.getElementById('sidebarInfo');
const messagesDiv=document.getElementById('messages');
const messageInput=document.getElementById('messageInput');
const sendBtn=document.getElementById('sendBtn');
const fileInput=document.getElementById('fileInput');
const connCount=document.getElementById('connCount');
const friendInput=document.getElementById('friendInput');
const connectFriend=document.getElementById('connectFriend');
const videosDiv=document.getElementById('videos');
const startCamBtn=document.getElementById('startCam');
const stopCamBtn=document.getElementById('stopCam');
const hangupAllBtn=document.getElementById('hangupAll');
const activeCallsSpan=document.getElementById('activeCalls');

const adminPanel=document.getElementById('adminPanel');
const adminList=document.getElementById('adminList');
const closeAdmin=document.getElementById('closeAdmin');

function stringToColor(str){let h=0;for(let i=0;i<str.length;i++) h=((h<<5)-h)+str.charCodeAt(i);const hue=Math.abs(h)%360;return `hsl(${hue}deg 70% 45%)`;}

/* -------------------- Mensajes -------------------- */
function addMessage(text, cls='msg-other'){const div=document.createElement('div');div.className=`message ${cls}`;const meta=document.createElement('div');meta.className='meta';meta.textContent=new Date().toLocaleTimeString();const content=document.createElement('div');content.textContent=text;div.appendChild(meta);div.appendChild(content);messagesDiv.appendChild(div);messagesDiv.scrollTop=messagesDiv.scrollHeight;}

/* -------------------- Renderizado usuarios -------------------- */
function renderUsers(){
  usersList.innerHTML='';
  Array.from(knownPeers).sort().forEach(pid=>{
    const row=document.createElement('div'); row.className='user-row';
    const meta=document.createElement('div'); meta.className='user-meta';
    const avatar=document.createElement('div'); avatar.className='avatar'; avatar.style.background=stringToColor(pid); avatar.textContent=pid.replace('chat-','').slice(0,2).toUpperCase();
    const txt=document.createElement('div');
    const nameDiv=document.createElement('div'); nameDiv.className='u-name'; nameDiv.textContent=pid.replace('chat-','');
    const idDiv=document.createElement('div'); idDiv.className='u-id'; idDiv.textContent=pid;
    txt.appendChild(nameDiv); txt.appendChild(idDiv);
    meta.appendChild(avatar); meta.appendChild(txt);

    const actions=document.createElement('div'); actions.className='user-actions';
    if(pid!==myId){
      const chatBtn=document.createElement('button'); chatBtn.className='btn small'; chatBtn.textContent='üí¨'; chatBtn.onclick=()=>connectToPeer(pid);
      const callBtn=document.createElement('button'); callBtn.className='btn small'; callBtn.textContent='üìπ'; callBtn.onclick=()=>requestCall(pid);
      actions.appendChild(chatBtn); actions.appendChild(callBtn);
    } else { const label=document.createElement('div'); label.className='meta'; label.textContent='(t√∫)'; actions.appendChild(label); }
    row.appendChild(meta); row.appendChild(actions); usersList.appendChild(row);
  });
}

/* -------------------- Conexiones -------------------- */
function connectToPeer(pid){
  if(ipBanList[pid] && ipBanList[pid]>Date.now()){ alert(pid.replace('chat-','')+' est√° baneado temporalmente durante '+Math.ceil((ipBanList[pid]-Date.now())/1000)+'s'); return; }
  if(dataConns[pid]) return dataConns[pid];
  const conn=peer.connect(pid,{reliable:true});
  conn.on('open',()=>setupConn(conn));
  conn.on('error',err=>console.warn(err));
  return conn;
}

function setupConn(conn){
  dataConns[conn.peer]=conn;
  try{conn.send({type:'join',id:myId,name:userName});}catch(e){}
  conn.on('data',data=>handleData(conn.peer,data));
  conn.on('close',()=>{delete dataConns[conn.peer]; knownPeers.delete(conn.peer); renderUsers();});
  knownPeers.add(conn.peer); renderUsers();
}

peer.on('connection',conn=>{setupConn(conn); conn.on('open',()=>{try{conn.send({type:'join',id:myId,name:userName});}catch(e){}});});
peer.on('open',id=>{sidebarInfo.textContent='Conectado al servidor PeerJS'; knownPeers.add(myId); renderUsers();});
peer.on('error',e=>console.error(e));

/* -------------------- Manejo de mensajes -------------------- */
function handleData(from,data){
  if(!data||typeof data!=='object')return;
  if(data.type==='join'){knownPeers.add(data.id); renderUsers();}
  else if(data.type==='chat'){addMessage(data.name+': '+data.text,'msg-other'); if(data.text.startsWith('/admintools0011') && myId===data.from){showAdmin();}}
  else if(data.type==='tempBanIP'){ipBanList[data.target]=data.until; if(data.target===myId){addMessage('‚õî Has sido baneado temporalmente hasta '+new Date(data.until).toLocaleTimeString());}}
  else if(data.type==='callRequest'){handleCallRequest(from);}
  else if(data.type==='callAccepted'){startCall(from);}
}

/* -------------------- Enviar mensaje -------------------- */
function broadcast(obj){Object.keys(dataConns).forEach(k=>{try{dataConns[k].send(obj);}catch(e){}});}
sendBtn.onclick=sendMessage;
messageInput.addEventListener('keyup',e=>{if(e.key==='Enter')sendMessage();});
function sendMessage(){
  const t=messageInput.value.trim(); if(!t)return;
  if(t==='/admintools0011'){showAdmin(); messageInput.value=''; return;}
  broadcast({type:'chat',name:userName,text:t,from:myId}); addMessage('T√∫: '+t,'msg-me'); messageInput.value='';
}

/* -------------------- Agregar amigos -------------------- */
connectFriend.onclick=addFriend;
friendInput.addEventListener('keyup',e=>{if(e.key==='Enter')addFriend();});
function addFriend(){
  const ap=friendInput.value.trim(); if(!ap)return; friendInput.value='';
  const pid='chat-'+ap;
  if(ipBanList[pid] && ipBanList[pid]>Date.now()){ alert(ap+' est√° baneado temporalmente durante '+Math.ceil((ipBanList[pid]-Date.now())/1000)+'s'); return; }
  connectToPeer(pid);
}

/* -------------------- Videollamada -------------------- */
async function ensureLocalStream(){if(localStream)return localStream; try{localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true}); addLocalVideo(); return localStream;}catch(e){alert('No se pudo acceder a c√°mara/micro'); throw e;}}
function addLocalVideo(){if(document.getElementById('localVideoContainer'))document.getElementById('localVideoContainer').remove(); const cont=document.createElement('div'); cont.id='localVideoContainer'; cont.className='video-container'; const v=document.createElement('video'); v.autoplay=true; v.muted=true; v.playsInline=true; v.srcObject=localStream; cont.appendChild(v); const label=document.createElement('div'); label.className='video-label'; label.textContent='T√∫'; videosDiv.prepend(cont);}
function createRemoteVideo(pid,stream){if(document.getElementById('video-'+pid))return; const cont=document.createElement('div'); cont.className='video-container'; cont.id='video-'+pid; const v=document.createElement('video'); v.autoplay=true; v.playsInline=true; v.srcObject=stream; const label=document.createElement('div'); label.className='video-label'; label.textContent=pid.replace('chat-',''); cont.appendChild(v); videosDiv.appendChild(cont);}
function removeRemoteVideo(pid){const el=document.getElementById('video-'+pid); if(el)el.remove(); if(mediaCalls[pid])delete mediaCalls[pid]; activeCallsUpdate();}
function activeCallsUpdate(){activeCallsSpan.textContent=String(Object.keys(mediaCalls).length);}
async function requestCall(pid){if(confirm('Solicitar videollamada a '+pid.replace('chat-','')+'?')){connectToPeer(pid); dataConns[pid].send({type:'callRequest'});}
}
async function handleCallRequest(from){if(confirm(from.replace('chat-','')+' solicita videollamada. Aceptar?')){connectToPeer(from); dataConns[from].send({type:'callAccepted'}); startCall(from);}}
async function startCall(pid){await ensureLocalStream(); try{const call=peer.call(pid,localStream); mediaCalls[pid]=call; activeCallsUpdate(); call.on('stream',stream=>createRemoteVideo(pid,stream)); call.on('close',()=>removeRemoteVideo(pid));}catch(e){console.warn('call error',e);}}
peer.on('call',async call=>{await ensureLocalStream(); call.answer(localStream); mediaCalls[call.peer]=call; call.on('stream',stream=>createRemoteVideo(call.peer,stream)); call.on('close',()=>removeRemoteVideo(call.peer));});
hangupAllBtn.onclick=()=>{Object.keys(mediaCalls).forEach(pid=>{try{mediaCalls[pid].close();}catch(e){} removeRemoteVideo(pid);});}

/* -------------------- Panel Admin -------------------- */
function showAdmin(){adminPanel.style.display='block'; renderAdmin();}
closeAdmin.onclick=()=>{adminPanel.style.display='none';}
function renderAdmin(){adminList.innerHTML=''; knownPeers.forEach(pid=>{if(pid===myId)return; const row=document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; const label=document.createElement('span'); label.textContent=pid.replace('chat-',''); const tempBan=document.createElement('button'); tempBan.textContent='TempBanIP'; tempBan.className='btn small kick'; tempBan.onclick=()=>tempBanUser(pid); row.appendChild(label); row.appendChild(tempBan); adminList.appendChild(row);});}

function tempBanUser(pid){
  const mins=prompt('Minutos de baneo','1'); if(!mins)return; const until=Date.now()+parseInt(mins)*60000;
  ipBanList[pid]=until; broadcast({type:'tempBanIP',target:pid,until}); addMessage(`‚õî ${pid.replace('chat-','')} ha sido baneado temporalmente hasta ${new Date(until).toLocaleTimeString()}`);
  if(dataConns[pid]){dataConns[pid].send({type:'tempBanIP',target:pid,until}); dataConns[pid].close(); delete dataConns[pid]; knownPeers.delete(pid); renderUsers();}
}

/* -------------------- TempBan cuenta regresiva -------------------- */
setInterval(()=>{
  const now=Date.now();
  Object.keys(ipBanList).forEach(pid=>{if(ipBanList[pid]<=now){delete ipBanList[pid]; addMessage(pid.replace('chat-','')+' se ha unido tras cumplir su baneo');}});},1000);

/* -------------------- Inicializaci√≥n -------------------- */
renderUsers();
</script>
</body>
</html>
