<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Chat P2P ‚Äî Moderaci√≥n Avanzada, Votaciones y Videollamadas (Versi√≥n Extendida)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* --------------------
       Estilos generales
       -------------------- */
    :root{--bg:#f4f6fb;--panel:#fff;--muted:#6b7280;--accent:#2563eb;--danger:#ef4444}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    .app{display:grid;grid-template-columns:320px 1fr;gap:12px;height:100vh;padding:12px;background:var(--bg);box-sizing:border-box}

    /* --------------------
       Sidebar (usuarios)
       -------------------- */
    .sidebar{background:var(--panel);border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(2,6,23,0.06);display:flex;flex-direction:column}
    .sidebar h3{margin:0 0 8px 0;font-size:16px}
    .sidebar .info{font-size:13px;color:var(--muted);margin-bottom:8px}
    #usersList{overflow:auto;flex:1;padding-right:6px}
    .user-row{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;margin-bottom:6px;transition:background .12s}
    .user-row:hover{background:#f1f5f9}
    .user-meta{display:flex;gap:8px;align-items:center;min-width:0}
    .avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff}
    .u-name{font-weight:600;font-size:14px;white-space:nowrap;text-overflow:ellipsis;overflow:hidden}
    .u-id{font-size:12px;color:var(--muted);max-width:110px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .user-actions{display:flex;gap:6px}
    .btn{padding:6px 8px;border-radius:8px;border:none;cursor:pointer;background:#eef2ff}
    .btn.small{padding:4px 6px;font-size:13px}
    .btn.kick{background:var(--danger);color:white}

    /* --------------------
       Main panel
       -------------------- */
    .main{display:flex;flex-direction:column;gap:10px}
    .top{display:flex;justify-content:space-between;gap:12px;align-items:center}
    .panel{background:var(--panel);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}

    /* mensajes/chat */
    .chat-wrap{display:flex;gap:12px;height:calc(100vh - 200px)}
    .chat{flex:1;display:flex;flex-direction:column}
    #messages{flex:1;overflow:auto;padding:12px;border-radius:8px;border:1px solid #edf2f7;background:linear-gradient(180deg,#fff,#fbfdff)}
    .message{margin:6px 0;padding:8px 10px;border-radius:8px;max-width:75%}
    .msg-me{background:#e6f0ff;align-self:flex-end}
    .msg-other{background:#f3f4f6;align-self:flex-start}
    .meta{font-size:11px;color:var(--muted);margin-bottom:4px}
    .controls{display:flex;gap:8px;align-items:center;margin-top:8px}
    input[type='text']{padding:10px;border-radius:8px;border:1px solid #e6eef8;flex:1}

    /* videos */
    #videos{display:flex;gap:12px;flex-wrap:wrap;padding:8px;border-radius:8px;border:1px dashed #e6eef8;min-height:140px;background:linear-gradient(180deg,#fff,#fbfdff)}
    .video-container{position:relative;width:260px;height:190px;border-radius:8px;overflow:hidden;background:black;display:flex;align-items:center;justify-content:center}
    .video-container video{width:100%;height:100%;object-fit:cover}
    .video-label{position:absolute;bottom:6px;left:6px;background:rgba(0,0,0,.5);color:white;font-size:12px;padding:4px 6px;border-radius:6px}
    .video-kick{position:absolute;top:6px;right:6px;display:none}
    .video-container.admin .video-kick{display:block}

    /* votaciones */
    #votePanel{padding:10px;border-radius:8px;background:#fff4e6;border:1px solid #ffd8a8;display:none}
    .vote-row{display:flex;gap:8px;align-items:center}

    /* responsive */
    @media(max-width:900px){.app{grid-template-columns:1fr}.sidebar{order:2;height:220px}.main{order:1}.chat-wrap{height:420px}}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar panel">
      <h3>Personas en la app</h3>
      <div class="info" id="sidebarInfo">Conectando...</div>
      <div id="usersList"></div>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <button id="refreshBtn" class="btn small">üîÑ Refrescar</button>
        <button id="adminBtn" class="btn small">üîë Modo Admin</button>
      </div>
      <div style="margin-top:12px;font-size:13px;color:var(--muted)"><div><strong>Tu nombre:</strong> <span id="meName"></span></div><div style="margin-top:6px"><strong>ID:</strong> <span id="meId"></span></div></div>
    </aside>

    <main class="main">
      <div class="top">
        <h2 style="margin:0">Chat P2P ‚Äî Moderaci√≥n y Videollamada</h2>
        <div style="display:flex;gap:8px;align-items:center"><button id="inviteAll" class="btn small">üìû Invitar a llamada</button><button id="proposeClear" class="btn small">üóë Proponer borrar chat</button></div>
      </div>

      <div class="panel chat-wrap">
        <section class="chat panel" style="flex:1 1 60%">
          <div id="messages" aria-live="polite"></div>
          <div class="controls">
            <input id="messageInput" type="text" placeholder="Escribe un mensaje..." />
            <button id="sendBtn" class="btn">Enviar</button>
            <label class="btn small">üìÅ<input id="fileInput" type="file" style="display:none"></label>
            <div id="connCount" class="meta" style="margin-left:8px">Conexiones: 0</div>
          </div>
        </section>

        <aside style="width:420px;display:flex;flex-direction:column;gap:8px">
          <div class="panel">
            <div style="display:flex;justify-content:space-between;align-items:center"><strong>Videollamadas</strong><span class="meta">Activas: <span id="activeCalls">0</span></span></div>
            <div id="videos"></div>
            <div style="display:flex;gap:8px;margin-top:8px"><button id="startCam" class="btn small">Iniciar c√°mara</button><button id="stopCam" class="btn small">Detener c√°mara</button><button id="hangupAll" class="btn small">Colgar todo</button></div>
          </div>

          <div id="votePanel" class="panel"></div>
        </aside>
      </div>
    </main>
  </div>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    /* -------------------------------------------------
       Configuraci√≥n inicial y estado
       ------------------------------------------------- */
    const PASSWORD = '0011';
    const userName = prompt('Pon tu nombre (√∫nico para esta sesi√≥n):') || ('user'+Math.floor(Math.random()*1000));
    const myId = `chat-${userName}`;

    // PeerJS
    const peer = new Peer(myId);

    // Conexiones de datos y llamadas
    const dataConns = {}; // peerId -> DataConnection
    const mediaCalls = {}; // peerId -> MediaConnection

    // Usuarios conocidos y estado de bans
    let knownPeers = new Set(); // peers conocidos (incluye self)
    const banList = {}; // peerId -> {until: timestamp or Infinity}

    // Local media stream
    let localStream = null;

    // UI referencias
    const usersList = document.getElementById('usersList');
    const sidebarInfo = document.getElementById('sidebarInfo');
    const meName = document.getElementById('meName');
    const meId = document.getElementById('meId');

    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const fileInput = document.getElementById('fileInput');
    const connCount = document.getElementById('connCount');

    const videosDiv = document.getElementById('videos');
    const startCamBtn = document.getElementById('startCam');
    const stopCamBtn = document.getElementById('stopCam');
    const hangupAllBtn = document.getElementById('hangupAll');
    const activeCallsSpan = document.getElementById('activeCalls');

    const refreshBtn = document.getElementById('refreshBtn');
    const adminBtn = document.getElementById('adminBtn');
    const inviteAllBtn = document.getElementById('inviteAll');
    const proposeClearBtn = document.getElementById('proposeClear');
    const votePanel = document.getElementById('votePanel');

    meName.textContent = userName;
    meId.textContent = myId;

    let isAdmin = false;

    // Votaciones en curso
    // Estructura: { id: string, type: 'clearChat' | 'kick', targetId?, votes: {yes:Set, no:Set}, createdAt: Date }
    let currentVote = null;

    /* -------------------------------------------------
       Utilidades UI & Mensajer√≠a local
       ------------------------------------------------- */
    function addMessage(text, cls='msg-other'){
      const div = document.createElement('div');
      div.className = `message ${cls}`;
      const meta = document.createElement('div'); meta.className='meta'; meta.textContent = new Date().toLocaleTimeString();
      const content = document.createElement('div'); content.textContent = text;
      div.appendChild(meta); div.appendChild(content);
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function updateConnCount(){
      connCount.textContent = `Conexiones: ${Object.keys(dataConns).length}`;
      activeCallsSpan.textContent = String(Object.keys(mediaCalls).length);
    }

    /* -------------------------------------------------
       Discovery (propagaci√≥n de peers)
       - cuando se abre una dataConn se intercambia lista
       - cada peer re-broadcastea peers conocidos
       ------------------------------------------------- */
    async function requestPeersFrom(conn){
      try{ conn.send({type:'requestPeers', from:myId}); }catch(e){}
    }

    function integratePeers(list){
      let changed=false;
      list.forEach(p=>{ if(p && p!==myId && !knownPeers.has(p)){ knownPeers.add(p); changed=true; } });
      if(changed) renderUsers();
    }

    /* -------------------------------------------------
       Renderizado de la sidebar
       ------------------------------------------------- */
    function renderUsers(){
      usersList.innerHTML='';
      // Convert to sorted array for consistent UI
      const arr = Array.from(knownPeers).sort();
      if(!arr.includes(myId)) arr.unshift(myId);
      arr.forEach(pid=>{
        const row = document.createElement('div'); row.className='user-row';
        // Left: avatar + name
        const meta = document.createElement('div'); meta.className='user-meta';
        const avatar = document.createElement('div'); avatar.className='avatar'; avatar.style.background = stringToColor(pid); avatar.textContent = pid.replace('chat-','').slice(0,2).toUpperCase();
        const txt = document.createElement('div');
        const nameDiv = document.createElement('div'); nameDiv.className='u-name'; nameDiv.textContent = pid.replace('chat-','');
        const idDiv = document.createElement('div'); idDiv.className='u-id'; idDiv.textContent = pid;
        txt.appendChild(nameDiv); txt.appendChild(idDiv);
        meta.appendChild(avatar); meta.appendChild(txt);

        // Right: actions
        const actions = document.createElement('div'); actions.className='user-actions';
        if(pid !== myId){
          const chatBtn = document.createElement('button'); chatBtn.className='btn small'; chatBtn.title='Conectar/Chat'; chatBtn.textContent='üí¨'; chatBtn.onclick = ()=>{ connectToPeer(pid); };
          const callBtn = document.createElement('button'); callBtn.className='btn small'; callBtn.title='Llamar'; callBtn.textContent='üìπ'; callBtn.onclick = async ()=>{ await ensureLocalStream(); // ensure stream before calling
            connectToPeer(pid); setTimeout(()=>startCall(pid), 600);
          };
          const kickBtn = document.createElement('button'); kickBtn.className='btn small'; kickBtn.textContent='‚ãÆ'; kickBtn.title='Acciones'; kickBtn.onclick = ()=>{ showModerationMenu(pid, kickBtn); };
          actions.appendChild(chatBtn); actions.appendChild(callBtn); actions.appendChild(kickBtn);
        } else {
          const label = document.createElement('div'); label.className='meta'; label.textContent='(t√∫)'; actions.appendChild(label);
        }

        row.appendChild(meta); row.appendChild(actions);
        usersList.appendChild(row);
      });
      updateConnCount();
    }

    function showModerationMenu(pid, anchor){
      // Simple prompt-based menu to keep code concise; could be replaced by nice dropdown
      if(isAdmin){
        const choice = prompt(`Admin: qu√© hacer con ${pid.replace('chat-','')}? (kick,ban,tempban)
Para tempban escribe 'tempban:5' (minutos)`, 'kick');
        if(!choice) return;
        if(choice==='kick'){ doAdminKick(pid); }
        else if(choice==='ban'){ doAdminBan(pid); }
        else if(choice.startsWith('tempban')){ const parts = choice.split(':'); const mins = parts[1]?parseInt(parts[1]):5; doAdminTempban(pid, mins); }
      } else {
        const ok = confirm(`Proponer expulsi√≥n de ${pid.replace('chat-','')}? Esto iniciar√° votaci√≥n.`);
        if(ok){ startVote({type:'kick',targetId:pid,timeout:60}); }
      }
    }

    function stringToColor(str){ // deterministic color for avatar
      let h=0; for(let i=0;i<str.length;i++) h = ((h<<5)-h)+str.charCodeAt(i); const hue = Math.abs(h)%360; return `hsl(${hue}deg 70% 45%)`;
    }

    /* -------------------------------------------------
       Conexiones de datos (PeerJS DataConnection)
       ------------------------------------------------- */
    function connectToPeer(peerId){
      if(peerId===myId) return;
      if(dataConns[peerId]) return dataConns[peerId];
      const conn = peer.connect(peerId, { reliable:true });
      conn.on('open', ()=>{
        setupDataConn(conn);
      });
      conn.on('error', err=>console.warn('conn err',err));
      return conn;
    }

    function setupDataConn(conn){
      dataConns[conn.peer] = conn;
      // announce ourselves
      try{ conn.send({type:'join',id:myId,name:userName}); }catch(e){}
      // request their knowledge of peers
      requestPeersFrom(conn);

      conn.on('data', data=>handleData(conn.peer,data));
      conn.on('close', ()=>{
        delete dataConns[conn.peer]; knownPeers.delete(conn.peer); renderUsers(); updateConnCount();
      });
      // add peer locally
      knownPeers.add(conn.peer); renderUsers();
    }

    peer.on('connection', conn=>{
      // incoming data connection
      setupDataConn(conn);
      // ensure they know about us
      conn.on('open', ()=>{ try{ conn.send({type:'join',id:myId,name:userName}); }catch(e){} });
    });

    peer.on('open', id=>{
      sidebarInfo.textContent = 'Conectado al servidor PeerJS.';
      // add self
      knownPeers.add(myId);
      renderUsers();
      // proactively try to connect to some peers via listAllPeers if available
      tryFetchPeerList();
    });

    peer.on('error', e=>{ sidebarInfo.textContent = 'Error PeerJS: '+e; console.error(e); });

    /* -------------------------------------------------
       Manejo de mensajes entrantes por data channel
       ------------------------------------------------- */
    function handleData(from, data){
      if(!data || typeof data !== 'object') return;
      // console.log('data from',from,data);
      if(data.type==='join'){
        knownPeers.add(data.id); renderUsers();
      } else if(data.type==='requestPeers'){
        // reply with array of known peers
        const conn = dataConns[from]; if(conn){ try{ conn.send({type:'peersList',peers:Array.from(knownPeers)}); }catch(e){} }
      } else if(data.type==='peersList'){
        integratePeers(data.peers || []);
      } else if(data.type==='chat'){
        addMessage(`${data.name}: ${data.text}`,'msg-other');
      } else if(data.type==='file'){
        const a=document.createElement('a'); a.href=data.url; a.download=data.fileName; a.textContent=`üìé ${data.name} envi√≥ ${data.fileName}`; const p=document.createElement('div'); p.className='message msg-other'; p.appendChild(a); messagesDiv.appendChild(p);
      } else if(data.type==='voteStart'){
        // new vote
        receiveVoteStart(data);
      } else if(data.type==='voteCast'){
        // vote cast from remote
        receiveVoteCast(data);
      } else if(data.type==='voteEnd'){
        finalizeVote(data);
      } else if(data.type==='kick'){ // admin kicked
        if(data.target===myId){ addMessage('‚ùå Has sido expulsado (kick) por admin.'); setTimeout(()=>location.reload(),800); }
      } else if(data.type==='ban'){ if(data.target===myId){ addMessage('‚õî Has sido baneado.'); setTimeout(()=>location.reload(),800);} }
    }

    /* -------------------------------------------------
       Env√≠o de chat y archivos
       ------------------------------------------------- */
    sendBtn.onclick = ()=>{
      const t = messageInput.value.trim(); if(!t) return; broadcast({type:'chat',name:userName,text:t}); addMessage('T√∫: '+t,'msg-me'); messageInput.value='';
    };
    messageInput.addEventListener('keyup', e=>{ if(e.key==='Enter') sendBtn.click(); });

    fileInput.addEventListener('change', ()=>{
      const f = fileInput.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = ()=>{ const url = URL.createObjectURL(new Blob([reader.result])); broadcast({type:'file',name:userName,fileName:f.name,url}); addMessage('üìé T√∫ enviaste: '+f.name,'msg-me'); }; reader.readAsArrayBuffer(f); fileInput.value='';
    });

    function broadcast(obj){ for(const k in dataConns){ try{ dataConns[k].send(obj); }catch(e){} } }

    /* -------------------------------------------------
       Votaciones: start, cast, tally
       ------------------------------------------------- */
    function startVote(opts){
      if(currentVote) return alert('Ya hay una votaci√≥n en curso');
      const id = 'vote-'+Date.now();
      currentVote = {id, type:opts.type, targetId:opts.targetId||null, votes:{yes:new Set(),no:new Set()}, createdAt:Date.now(), timeout:opts.timeout||60};
      // cast our own vote as proposer = yes
      currentVote.votes.yes.add(myId);
      // broadcast to peers
      broadcast({type:'voteStart',vote:serializeVoteStart(currentVote),from:myId});
      renderVotePanel();
      scheduleVoteTimeout(currentVote.id, currentVote.timeout);
    }

    function receiveVoteStart(data){
      const v = data.vote; if(!v) return; if(currentVote) return; // ignore if already one
      currentVote = {id:v.id,type:v.type,targetId:v.targetId||null,votes:{yes:new Set(),no:new Set()},createdAt:v.createdAt,timeout:v.timeout};
      // automatically create UI and allow local user to vote
      renderVotePanel();
      scheduleVoteTimeout(currentVote.id,currentVote.timeout);
    }

    function serializeVoteStart(v){ return {id:v.id,type:v.type,targetId:v.targetId,createdAt:v.createdAt,timeout:v.timeout}; }

    function castVote(yes){
      if(!currentVote) return; // no vote
      if(currentVote.votes.yes.has(myId) || currentVote.votes.no.has(myId)) return alert('Ya votaste');
      const weight = isAdmin?2:1;
      // locally register
      if(yes) currentVote.votes.yes.add(myId); else currentVote.votes.no.add(myId);
      // broadcast cast
      broadcast({type:'voteCast',voteId:currentVote.id,from:myId,yes:yes,weight:weight});
      renderVotePanel();
      checkVoteFinish();
    }

    function receiveVoteCast(data){ if(!currentVote || data.voteId!==currentVote.id) return; if(data.yes) currentVote.votes.yes.add(data.from); else currentVote.votes.no.add(data.from); renderVotePanel(); checkVoteFinish(); }

    function checkVoteFinish(){
      // Simple majority over known peers (including self)
      const total = Array.from(knownPeers).filter(p=>!isBanned(p)).length; // eligible voters
      const yesCount = currentVote.votes.yes.size + (isAdmin && currentVote.votes.yes.has(myId)?(1):0); // admin double counted locally via weight already handled by sending weight? we'll keep simple: admin votes twice by adding admin id twice isn't possible; instead we will compute effective votes below
      // better: compute effective yes/no using weights of members
      let effYes=0, effNo=0;
      Array.from(knownPeers).forEach(pid=>{
        if(isBanned(pid)) return; // banned not counted
        const w = (pid===myId && isAdmin)?2:(pid===myId?1:(pid!==myId && isAdmin?1:1));
        // note: remote admin weighting isn't known here; for simplicity only local admin votes count x2
        if(currentVote.votes.yes.has(pid)) effYes += (pid===myId && isAdmin)?2:1;
        if(currentVote.votes.no.has(pid)) effNo += (pid===myId && isAdmin)?2:1;
      });
      // majority
      if(effYes>effNo && (effYes+effNo)>=Math.ceil(total/2)){
        // pass
        concludeVote(true);
      } else if(effNo>=effYes && (effYes+effNo)>=Math.ceil(total/2)){
        concludeVote(false);
      }
    }

    function concludeVote(result){
      if(!currentVote) return;
      // perform action
      if(result){
        if(currentVote.type==='clearChat') clearChat();
        else if(currentVote.type==='kick') doKick(currentVote.targetId);
      }
      // broadcast end
      broadcast({type:'voteEnd',voteId:currentVote.id,result});
      currentVote=null; renderVotePanel();
    }

    function finalizeVote(data){ if(currentVote && data.voteId===currentVote.id){ if(data.result) { if(currentVote.type==='clearChat') clearChat(); else if(currentVote.type==='kick') doKick(currentVote.targetId); } currentVote=null; renderVotePanel(); } }

    function renderVotePanel(){
      if(!currentVote){ votePanel.style.display='none'; votePanel.innerHTML=''; return; }
      votePanel.style.display='block'; votePanel.innerHTML='';
      const title = document.createElement('div'); title.innerHTML = `<strong>Votaci√≥n:</strong> ${currentVote.type}${currentVote.targetId? ' ‚Äî '+currentVote.targetId.replace('chat-',''):''}`;
      const votes = document.createElement('div'); votes.className='vote-row'; votes.textContent = `S√≠: ${currentVote.votes.yes.size}  No: ${currentVote.votes.no.size}`;
      const yesBtn = document.createElement('button'); yesBtn.className='btn small'; yesBtn.textContent='Votar S√≠'; yesBtn.onclick = ()=>castVote(true);
      const noBtn = document.createElement('button'); noBtn.className='btn small'; noBtn.textContent='Votar No'; noBtn.onclick = ()=>castVote(false);
      votePanel.appendChild(title); votePanel.appendChild(votes); votePanel.appendChild(yesBtn); votePanel.appendChild(noBtn);
    }

    function scheduleVoteTimeout(voteId, secs){ setTimeout(()=>{ if(!currentVote || currentVote.id!==voteId) return; // still active? tally and conclude by majority
      // naive tally: compare sizes
      const yes = currentVote.votes.yes.size; const no = currentVote.votes.no.size; const res = yes>no; concludeVote(res);
    }, secs*1000); }

    function clearChat(){ messagesDiv.innerHTML=''; addMessage('üóë Chat borrado por votaci√≥n (o admin)'); }

    /* -------------------------------------------------
       Acciones de moderaci√≥n aplicadas por admin o por vote
       ------------------------------------------------- */
    function doAdminKick(pid){ doKick(pid); broadcast({type:'kick',target:pid,by:myId}); }
    function doAdminBan(pid){ banList[pid] = {until:Infinity}; doKick(pid); broadcast({type:'ban',target:pid,by:myId}); }
    function doAdminTempban(pid, mins){ banList[pid] = {until: Date.now()+mins*60000}; doKick(pid); broadcast({type:'ban',target:pid,until:banList[pid].until,by:myId}); }

    function doKick(pid){
      // close data connection if exists
      if(dataConns[pid]){ try{ dataConns[pid].send({type:'kicked',by:myId}); dataConns[pid].close(); }catch(e){} }
      if(mediaCalls[pid]){ try{ mediaCalls[pid].close(); }catch(e){} }
      knownPeers.delete(pid); renderUsers(); addMessage(`‚ö†Ô∏è Se expuls√≥ a ${pid.replace('chat-','')}`);
    }

    /* -------------------------------------------------
       Manejo de voto remoto (recibido)
       ------------------------------------------------- */
    function receiveVoteStart(data){ if(currentVote) return; // ignore concurrent
      currentVote = {id:data.vote.id,type:data.vote.type,targetId:data.vote.targetId || null,votes:{yes:new Set(),no:new Set()},createdAt:data.vote.createdAt,timeout:data.vote.timeout}; renderVotePanel(); scheduleVoteTimeout(currentVote.id,currentVote.timeout); }
    function receiveVoteCast(data){ if(!currentVote || data.voteId!==currentVote.id) return; if(data.yes) currentVote.votes.yes.add(data.from); else currentVote.votes.no.add(data.from); renderVotePanel(); checkVoteFinish(); }

    /* -------------------------------------------------
       Ban checks
       ------------------------------------------------- */
    function isBanned(pid){ const b = banList[pid]; if(!b) return false; if(b.until===Infinity) return true; if(Date.now()>b.until){ delete banList[pid]; return false; } return true; }

    /* -------------------------------------------------
       Videollamadas: start / answer / manage elements
       ------------------------------------------------- */
    async function ensureLocalStream(){ if(localStream) return localStream; try{ localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true}); addLocalVideo(); return localStream; }catch(e){ alert('No se pudo acceder a c√°mara/micro: '+e); throw e; } }

    function addLocalVideo(){ // remove previous local if exists
      const existing = document.getElementById('localVideoContainer'); if(existing) existing.remove(); const cont = document.createElement('div'); cont.id='localVideoContainer'; cont.className='video-container'; const v=document.createElement('video'); v.autoplay=true; v.muted=true; v.playsInline=true; v.srcObject = localStream; cont.appendChild(v); const label = document.createElement('div'); label.className='video-label'; label.textContent='T√∫'; cont.appendChild(label); videosDiv.prepend(cont); }

    function createRemoteVideo(pid, stream){ if(document.getElementById('video-'+pid)) return; const cont = document.createElement('div'); cont.className='video-container'; cont.id='video-'+pid; if(isAdmin) cont.classList.add('admin'); const v=document.createElement('video'); v.autoplay=true; v.playsInline=true; v.srcObject = stream; const label = document.createElement('div'); label.className='video-label'; label.textContent = pid.replace('chat-',''); const kickBtn = document.createElement('button'); kickBtn.className='btn small video-kick'; kickBtn.textContent='Expulsar'; kickBtn.onclick = ()=>{ if(!isAdmin){ if(confirm('Proponer expulsi√≥n?')) startVote({type:'kick',targetId:pid,timeout:60}); } else { doAdminKick(pid); } }; cont.appendChild(v); cont.appendChild(label); cont.appendChild(kickBtn); videosDiv.appendChild(cont); }

    function removeRemoteVideo(pid){ const el = document.getElementById('video-'+pid); if(el) el.remove(); if(mediaCalls[pid]) delete mediaCalls[pid]; activeCallsUpdate(); }

    function activeCallsUpdate(){ activeCallsSpan.textContent = String(Object.keys(mediaCalls).length); }

    async function startCall(pid){ await ensureLocalStream(); try{ const call = peer.call(pid, localStream); mediaCalls[pid]=call; updateConnCount(); call.on('stream', stream => createRemoteVideo(pid, stream)); call.on('close', ()=>removeRemoteVideo(pid)); }catch(e){ console.warn('call error',e); } }

    peer.on('call', async call=>{ await ensureLocalStream(); call.answer(localStream); mediaCalls[call.peer]=call; call.on('stream', stream=>createRemoteVideo(call.peer, stream)); call.on('close', ()=>removeRemoteVideo(call.peer)); });

    hangupAllBtn.onclick = ()=>{ Object.keys(mediaCalls).forEach(pid=>{ try{ mediaCalls[pid].close(); }catch(e){} delete mediaCalls[pid]; removeRemoteVideo(pid); }); activeCallsUpdate(); addMessage('üì¥ Has colgado todas las llamadas'); };
    startCamBtn.onclick = ()=>ensureLocalStream(); stopCamBtn.onclick = ()=>{ if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; const el = document.getElementById('localVideoContainer'); if(el) el.remove(); } };

    /* -------------------------------------------------
       Acciones admin helper
       ------------------------------------------------- */
    function doKick(pid){ // used by votes
      if(dataConns[pid]){ try{ dataConns[pid].send({type:'kicked',by:myId}); dataConns[pid].close(); }catch(e){} }
      if(mediaCalls[pid]){ try{ mediaCalls[pid].close(); }catch(e){} }
      knownPeers.delete(pid); renderUsers(); addMessage(`‚ö†Ô∏è ${pid.replace('chat-','')} fue expulsado`);
    }

    function doAdminBan(pid){ banList[pid] = {until:Infinity}; doKick(pid); broadcast({type:'ban',target:pid,by:myId}); }
    function doAdminTempban(pid, mins){ banList[pid] = {until:Date.now()+mins*60000}; doKick(pid); broadcast({type:'ban',target:pid,until:banList[pid].until,by:myId}); }

    function handleRemoteKicked(from){ if(from===myId){ alert('Has sido expulsado.'); location.reload(); } }

    /* -------------------------------------------------
       Invitar a todos a llamada (join): envia mensaje de invitaci√≥n
       ------------------------------------------------- */
    inviteAllBtn.onclick = async ()=>{
      await ensureLocalStream(); const targets = Array.from(knownPeers).filter(p=>p!==myId && !isBanned(p)); if(targets.length===0){ addMessage('No hay peers a invitar'); return; } addMessage('üìû Invitando a llamada grupal...'); targets.forEach(pid=>{ if(dataConns[pid]){ try{ dataConns[pid].send({type:'groupInvite',from:myId}); }catch(e){} } startCall(pid); }); };

    /* -------------------------------------------------
       Votar borrar chat
       ------------------------------------------------- */
    proposeClearBtn.onclick = ()=>{ startVote({type:'clearChat',timeout:60}); };

    /* -------------------------------------------------
       Recepci√≥n y respuesta a mensajes de control
       ------------------------------------------------- */
    function handleControlMessage(from, data){ // not used directly; left for extensibility
    }

    /* -------------------------------------------------
       Peer list discovery via listAllPeers (when server supports)
       ------------------------------------------------- */
    async function tryFetchPeerList(){
      if(!peer.listAllPeers) return; try{
        peer.listAllPeers(list=>{ if(Array.isArray(list)){ list.forEach(id=>{ if(id && id.startsWith('chat-')) knownPeers.add(id); }); renderUsers(); sidebarInfo.textContent = `Peers descubiertos: ${knownPeers.size-1}`; } });
      }catch(e){ console.warn('listAllPeers unavailable',e); sidebarInfo.textContent = 'Servidor no permite listAllPeers ‚Äî conecte manualmente'; }
    }

    refreshBtn.onclick = ()=>{ tryFetchPeerList(); };

    /* -------------------------------------------------
       Manejo de datos entrantes (centralizado)
       ------------------------------------------------- */
    function handleData(peerId, data){ handleData(peerId,data); }
    // NOTE: earlier we added conn.on('data', handleData) but to avoid collision we kept 'handleData' named above.

    /* -------------------------------------------------
       Inicializaci√≥n: intentar reconectar a peers conocidos peri√≥dicamente
       ------------------------------------------------- */
    setInterval(()=>{ // try to connect to known peers returned by listAllPeers
      tryFetchPeerList(); Array.from(knownPeers).forEach(pid=>{ if(pid!==myId && !dataConns[pid] && !isBanned(pid)){ try{ connectToPeer(pid); }catch(e){} } }); }, 5000);

    /* -------------------------------------------------
       Cuando el peer recibe conexiones, setupDataConn ya maneja todo.
       Tambi√©n tenemos que manejar mensajes de tipo 'kicked' 'ban' 'groupInvite' y 'vote' que se procesan en handleData
       ------------------------------------------------- */
    // TODO: We need to ensure every conn.on('data') calls handleData properly above when created in setupDataConn. Already done.

    /* -------------------------------------------------
       Seguridad simple: si banned, mostrar mensaje al entrar
       ------------------------------------------------- */
    window.addEventListener('load', ()=>{ if(isBanned(myId)){ alert('Est√°s baneado y no puedes unirte'); } });

    /* -------------------------------------------------
       Mejoras: exponer funciones que se usan por prompts/menus
       ------------------------------------------------- */
    window.connectToPeer = connectToPeer; window.startCall = startCall; window.startVote = startVote; window.doAdminKick = doAdminKick; window.doAdminBan = doAdminBan; window.doAdminTempban = doAdminTempban;

    /* -------------------------------------------------
       Nota final: este archivo est√° largo y contiene comentarios y estructura modular.
       En producci√≥n, convierte esto en m√≥dulos separados y a√±ade un servidor central para discovery/introducer.
       ------------------------------------------------- */
  </script>
</body>
</html>
