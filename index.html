<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Chat P2P Clase + Videollamada + Moderaci√≥n</title>
<style>
body { font-family: sans-serif; background: #f5f5f5; padding: 10px; }
#chat { border: 1px solid #ccc; background: #fff; height: 250px; overflow-y: auto; margin-bottom: 8px; padding: 5px; }
input, button, select { padding: 5px; margin: 3px; }
#friends, #classIndex { margin-bottom: 10px; }
.hidden { display: none; }
video { width: 300px; height: 225px; background: black; margin: 5px; position: relative; }
#videos { margin-top: 10px; display: flex; flex-wrap: wrap; align-items: flex-start; }
.video-container { position: relative; display: inline-block; margin-right: 15px; }
.video-label { position: absolute; top: 3px; left: 5px; background: rgba(0,0,0,0.5); color: #fff; padding: 2px 5px; font-size: 12px; border-radius: 3px; }
#localVideo { border: 2px solid green; }
video.remote { border: 2px solid blue; }
.kick-btn { position: absolute; top: 5px; right: 5px; background: rgba(255,0,0,0.7); color: white; border: none; padding: 2px 6px; font-size: 12px; border-radius: 3px; cursor: pointer; display: none; z-index: 10; }
.admin .kick-btn { display: block; }
#classIndex { border: 1px solid #ccc; background: #fff; padding: 5px; max-height: 350px; overflow-y: auto; }
.class-header { font-weight: bold; cursor: pointer; margin: 5px 0; }
.user-list { margin-left: 10px; display: none; }
.user-item { cursor: pointer; margin: 2px 0; }
.user-item:hover { text-decoration: underline; }
</style>
</head>
<body>
<h2>Chat P2P por Clase + Videollamada</h2>

<div id="userSelector">
  <label>Selecciona tu clase:</label>
  <select id="classSelect">
    <option value="A">Clase A</option>
    <option value="B">Clase B</option>
    <option value="C">Clase C</option>
  </select>
  <label>N√∫mero de lista:</label>
  <select id="numberSelect"></select>
  <label>Tu apodo:</label>
  <input type="text" id="nickname" placeholder="Apodo visible">
  <button id="enterChatBtn">Entrar al chat</button>
</div>

<div id="mainUI" class="hidden">
  <div id="userInfo"></div>
  <div id="classIndex"></div>
  <div id="chat"></div>

  <input type="text" id="messageInput" placeholder="Mensaje">
  <button id="sendBtn">Enviar</button>

  <input type="file" id="fileInput" class="hidden">
  <button id="sendFileBtn">üìÅ Enviar archivo</button>

  <div id="devControls" class="hidden">
    <button id="voteClearBtn">üóë Votaci√≥n borrar chat</button>
  </div>

  <br>
  <button id="devModeBtn">Modo Admin</button>

  <hr>
  <h3>Videollamada</h3>
  <div id="videos">
    <div class="video-container" id="localVideoContainer">
      <video id="localVideo" autoplay muted></video>
      <div class="video-label" id="label-local">T√∫</div>
    </div>
    <div class="video-container admin" id="remoteVideoContainer">
      <video class="remote" id="remoteVideo" autoplay></video>
      <button class="kick-btn" id="kickBtn">Expulsar</button>
      <div class="video-label" id="label-remote"></div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
const PASSWORD = "0011";
let localStream = null;
let currentCall = null;
let currentCallPeerId = null;
let connections = {};
let isAdmin = false;
let userId = "";
let nickname = "";
let className = "";
let number = 0;

// Generar lista de 1-30
const numberSelect = document.getElementById("numberSelect");
for(let i=1;i<=30;i++){
  const opt = document.createElement("option");
  opt.value=i;
  opt.text=i;
  numberSelect.appendChild(opt);
}

// Variables DOM
const userSelector = document.getElementById("userSelector");
const enterChatBtn = document.getElementById("enterChatBtn");
const mainUI = document.getElementById("mainUI");
const userInfo = document.getElementById("userInfo");
const chatDiv = document.getElementById("chat");
const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const fileInput = document.getElementById("fileInput");
const sendFileBtn = document.getElementById("sendFileBtn");
const devModeBtn = document.getElementById("devModeBtn");
const devControls = document.getElementById("devControls");
const voteClearBtn = document.getElementById("voteClearBtn");
const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const remoteLabel = document.getElementById("label-remote");
const kickBtn = document.getElementById("kickBtn");
const remoteVideoContainer = document.getElementById("remoteVideoContainer");
const classIndex = document.getElementById("classIndex");

// Variables votaci√≥n
let clearVotes = {};
let totalUsers = 0;

// Usuarios baneados temporalmente {id: timestamp_fin}
let tempBans = {};

function addMessage(msg){ const p=document.createElement("p"); p.textContent=msg; chatDiv.appendChild(p); chatDiv.scrollTop=chatDiv.scrollHeight; }
function clearChatLocal(){ chatDiv.innerHTML=""; }

function setupConnection(conn){
  connections[conn.peer]=conn;
  conn.on("data", data=>{
    if(data.type==="expulsion"){
      addMessage("‚ùå Has sido expulsado del chat.");
      if(currentCall){ currentCall.close(); currentCall=null; currentCallPeerId=null; remoteVideo.srcObject=null; remoteLabel.textContent=""; }
      conn.close();
    } else if(data.type==="kick"){
      addMessage(`‚ö†Ô∏è ${data.nick} ha sido expulsado del chat por votaci√≥n.`);
    } else if(data.type==="tempban"){
      tempBans[conn.peer]=Date.now()+data.duration*60000;
      addMessage(`‚è± ${data.nick} ha sido temporalmente baneado por ${data.duration} min.`);
    } else if(data.type==="clearChatVote"){
      clearVotes[data.from]=(clearVotes[data.from]||0)+data.weight;
      checkClearVotes();
    } else if(data.type==="file"){
      const link=document.createElement("a"); link.href=data.url; link.download=data.fileName; link.textContent=`üìé Archivo recibido: ${data.fileName}`; const p=document.createElement("p"); p.appendChild(link); chatDiv.appendChild(p); chatDiv.scrollTop=chatDiv.scrollHeight;
    } else if(data.type==="message"){
      addMessage(`${data.nick}: ${data.text}`);
    }
  });

  conn.on("close", ()=>{
    delete connections[conn.peer];
    addMessage(`‚ùå ${conn.peer} se ha desconectado.`);
    if(currentCallPeerId===conn.peer) endCurrentCall();
  });
}

function checkClearVotes(){
  let sum=0;
  for(const k in clearVotes) sum+=clearVotes[k];
  if(sum>=Math.ceil(totalUsers/2)){
    clearChatLocal();
    addMessage("üóë El chat ha sido borrado por votaci√≥n.");
    clearVotes={};
  }
}

function startCall(friendId){
  if(!localStream){
    navigator.mediaDevices.getUserMedia({video:true,audio:true}).then(stream=>{localStream=stream; localVideo.srcObject=stream; callPeer(friendId);}).catch(e=>alert("Error c√°mara/mic: "+e));
  } else callPeer(friendId);
}

function callPeer(friendId){
  if(currentCall) endCurrentCall();
  const call=peer.call(friendId, localStream);
  currentCall=call;
  currentCallPeerId=friendId;
  call.on("stream", remoteStream=>{ remoteVideo.srcObject=remoteStream; remoteLabel.textContent=friendId; });
  call.on("close", ()=>{ addMessage("üì¥ Llamada terminada."); endCurrentCall(); });
}

function endCurrentCall(){ if(currentCall){ currentCall.close(); currentCall=null; currentCallPeerId=null; } remoteVideo.srcObject=null; remoteLabel.textContent=""; }

function generateClassIndex(){
  classIndex.innerHTML="";
  ["A","B","C"].forEach(cl=>{
    const header=document.createElement("div"); header.textContent="Clase "+cl; header.classList.add("class-header");
    const list=document.createElement("div"); list.classList.add("user-list"); list.id="list-"+cl;
    for(let i=1;i<=30;i++){
      const userItem=document.createElement("div"); userItem.textContent=`Usuario ${i}`; userItem.classList.add("user-item");
      userItem.onclick=()=>{ alert(`Iniciar chat con ${userItem.textContent} (implementar conexi√≥n)`); };
      list.appendChild(userItem);
    }
    header.onclick=()=>{ list.style.display=(list.style.display==="none"?"block":"none"); };
    classIndex.appendChild(header); classIndex.appendChild(list);
  });
}

// Botones
enterChatBtn.onclick=()=>{
  className=document.getElementById("classSelect").value;
  number=document.getElementById("numberSelect").value;
  nickname=document.getElementById("nickname").value.trim()||("User"+Math.floor(Math.random()*1000));
  userId=`chat-${className}-${number}`;
  userSelector.classList.add("hidden");
  mainUI.classList.remove("hidden");
  userInfo.textContent=`Tu ID: ${userId} - Apodo: ${nickname}`;
  generateClassIndex();
  setupPeer();
};

function setupPeer(){
  peer=new Peer(userId);
  peer.on("connection", setupConnection);
  peer.on("call", call=>{
    if(!localStream){
      navigator.mediaDevices.getUserMedia({video:true,audio:true}).then(stream=>{localStream=stream; localVideo.srcObject=stream; answerCall(call);}).catch(e=>{alert("Error c√°mara/mic: "+e); call.close();});
    } else answerCall(call);
  });
}

function answerCall(call){
  if(currentCall) endCurrentCall();
  call.answer(localStream);
  currentCall=call;
  currentCallPeerId=call.peer;
  call.on("stream", remoteStream=>{ remoteVideo.srcObject=remoteStream; remoteLabel.textContent=call.peer; });
  call.on("close", ()=>{ addMessage("üì¥ Llamada terminada."); endCurrentCall(); });
  addMessage(`üìπ Recibida llamada de ${call.peer}`);
}

// Chat
sendBtn.onclick=()=>{
  const text=messageInput.value.trim();
  if(!text) return;
  for(const id in connections) connections[id].send({type:"message",text,nick:nickname});
  addMessage(`${nickname}: ${text}`);
  messageInput.value="";
};
messageInput.addEventListener("keypress", e=>{ if(e.key==="Enter") sendBtn.click(); });

// Archivos
sendFileBtn.onclick=()=>fileInput.click();
fileInput.onchange=()=>{
  const file=fileInput.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=()=>{
    const blob=new Blob([reader.result]);
    const url=URL.createObjectURL(blob);
    for(const id in connections) connections[id].send({type:"file",fileName:file.name,url});
    const link=document.createElement("a"); link.href=url; link.download=file.name; link.textContent=`üìé T√∫ enviaste: ${file.name}`;
    const p=document.createElement("p"); p.appendChild(link); chatDiv.appendChild(p); chatDiv.scrollTop=chatDiv.scrollHeight;
  };
  reader.readAsArrayBuffer(file);
  fileInput.value="";
};

// Modo Admin
devModeBtn.onclick=()=>{
  const pwd=prompt("Introduce la contrase√±a:");
  if(pwd===PASSWORD){ isAdmin=true; devControls.classList.remove("hidden"); remoteVideoContainer.classList.add("admin"); addMessage("üîë Modo Admin activado."); }
  else alert("Contrase√±a incorrecta.");
};

// Kick / Tempban / Ban
kickBtn.onclick=()=>{
  if(!isAdmin) return alert("Solo admin puede expulsar.");
  if(!currentCallPeerId) return alert("No hay usuario en videollamada.");
  if(confirm(`Expulsar a ${currentCallPeerId}?`)){
    connections[currentCallPeerId]?.send({type:"expulsion"});
    connections[currentCallPeerId]?.close();
    delete connections[currentCallPeerId];
    addMessage(`‚ö†Ô∏è Expulsaste a ${currentCallPeerId}`);
    endCurrentCall();
  }
};

// Votaci√≥n para borrar chat
voteClearBtn.onclick=()=>{
  const weight=isAdmin?2:1;
  for(const id in connections) connections[id].send({type:"clearChatVote",from:userId,weight});
  clearVotes[userId]=weight;
  checkClearVotes();
};

window.onbeforeunload=()=>{ for(const id in connections) connections[id].close(); peer.destroy(); };
</script>
</body>
</html>
