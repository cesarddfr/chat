<!DOCTYPE html> <html lang="es"> <head> <meta charset="utf-8"/> <meta name="viewport" content="width=device-width,initial-scale=1"/> <title>Apuntes</title> <style> :root{ --bg:#f4f6fb; --panel:#fff; --muted:#6b7280; --accent:#2563eb; --danger:#ef4444; --success:#10b981; } html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg)} .app{display:grid;grid-template-columns:320px 1fr;gap:12px;height:100vh;padding:12px;box-sizing:border-box} .sidebar{background:var(--panel);border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(2,6,23,0.06);display:flex;flex-direction:column} .sidebar h3{margin:0 0 8px 0;font-size:16px} .sidebar .info{font-size:13px;color:var(--muted);margin-bottom:8px} #usersList{overflow:auto;flex:1;padding-right:6px} .user-row{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;margin-bottom:6px;transition:background .12s} .user-row:hover{background:#f1f5f9} .user-meta{display:flex;gap:8px;align-items:center;min-width:0} .avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff} .u-name{font-weight:600;font-size:14px;white-space:nowrap;text-overflow:ellipsis;overflow:hidden} .u-id{font-size:12px;color:var(--muted);max-width:110px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis} .user-actions{display:flex;gap:6px} .btn{padding:6px 8px;border-radius:8px;border:none;cursor:pointer;background:#eef2ff;transition:background .12s} .btn.small{padding:4px 6px;font-size:13px} .btn.kick{background:var(--danger);color:white} .main{display:flex;flex-direction:column;gap:10px} .top{display:flex;justify-content:space-between;gap:12px;align-items:center} .panel{background:var(--panel);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.06)} .chat-wrap{display:flex;gap:12px;height:calc(100vh - 200px)} .chat{flex:1;display:flex;flex-direction:column} #messages{flex:1;overflow:auto;padding:12px;border-radius:8px;border:1px solid #edf2f7;background:linear-gradient(180deg,#fff,#fbfdff)} .message{margin:6px 0;padding:8px 10px;border-radius:8px;max-width:75%} .msg-me{background:#e6f0ff;align-self:flex-end} .msg-other{background:#f3f4f6;align-self:flex-start} .meta{font-size:11px;color:var(--muted);margin-bottom:4px} .controls{display:flex;gap:8px;align-items:center;margin-top:8px} input[type='text']{padding:10px;border-radius:8px;border:1px solid #e6eef8;flex:1} #videos{display:flex;gap:12px;flex-wrap:wrap;padding:8px;border-radius:8px;border:1px dashed #e6eef8;min-height:160px;background:linear-gradient(180deg,#fff,#fbfdff)} .video-container{position:relative;width:260px;height:190px;border-radius:8px;overflow:hidden;background:black;display:flex;align-items:center;justify-content:center} .video-container video,.video-container canvas{width:100%;height:100%;object-fit:cover} .video-label{position:absolute;bottom:6px;left:6px;background:rgba(0,0,0,.5);color:white;font-size:12px;padding:4px 6px;border-radius:6px} .frozen-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);color:white;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:bold} #adminPanel{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--panel);border-radius:12px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.15);z-index:999;width:520px} #adminPanel h2{margin-top:0} .admin-option{margin-bottom:16px;padding:10px;border:1px solid #e2e8f0;border-radius:8px} .admin-option label{display:block;margin:4px 0;font-size:14px} .admin-buttons{display:flex;justify-content:flex-end;gap:8px;margin-top:12px} #nameModal{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:2000} #nameModal .box{background:#000;color:#fff;padding:24px;border-radius:10px;min-width:320px;text-align:center} #nameModal input{width:100%;padding:10px;border-radius:8px;border:1px solid #333;margin-top:12px;background:#111;color:#fff} #nameModal button{margin-top:10px;padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer} .statusWrap{display:flex;align-items:center;gap:8px;justify-content:center;margin-top:10px} .spinner{width:20px;height:20px;border-radius:50%;border:3px solid rgba(255,255,255,0.2);border-top-color:#ff4d4d;animation:spin 1s linear infinite;display:inline-block} @keyframes spin{to{transform:rotate(360deg)}} .tick{width:24px;height:24px;border-radius:50%;background:var(--success);color:white;display:flex;align-items:center;justify-content:center;font-weight:700} .errorText{color:var(--danger);margin-top:8px} #invitePanel{position:fixed;left:50%;transform:translateX(-50%);top:12px;background:#fff;border-radius:8px;padding:10px 14px;box-shadow:0 8px 30px rgba(0,0,0,0.2);z-index:3000;display:none;align-items:center;gap:10px} .file-link{color:var(--accent);text-decoration:underline;cursor:pointer} #passwordModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;z-index:2500} #passwordModal .box{background:#fff;padding:18px;border-radius:10px;width:320px} #banReasonReveal{display:inline-block;margin-left:8px;cursor:pointer} .friend-request-panel{display:none;position:fixed;left:50%;transform:translateX(-50%);top:70px;background:#fff;padding:10px;border-radius:8px;box-shadow:0 8px 30px rgba(0,0,0,0.2);z-index:4000} .confirmModal{position:fixed;inset:0;background:rgba(0,0,0,0.65);display:none;align-items:center;justify-content:center;z-index:6000} .confirmModal .box{background:#fff;padding:14px;border-radius:8px;width:320px;text-align:center} .connectedListModal{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:6000} .connectedListModal .box{background:#fff;padding:16px;border-radius:8px;width:540px;max-height:70vh;overflow:auto} .voteModal{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:6500} .voteModal .box{background:#fff;padding:16px;border-radius:8px;width:420px} @media (max-width:900px){.app{grid-template-columns:1fr;grid-template-rows:auto 1fr}.sidebar{order:2}} </style> </head> <body> <div class="app"> <aside class="sidebar panel"> <h3>Amigos conectados</h3> <div class="info" id="sidebarInfo">Conectando...</div> <div id="usersList"></div> <div style="margin-top:8px;display:flex;gap:8px;align-items:center"> <input id="friendInput" type="text" placeholder="Apodo amigo" style="flex:1;padding:6px;border-radius:6px;border:1px solid #ccc"> <button id="connectFriend" class="btn small">💬 Conectar</button> </div> <div style="margin-top:12px;font-size:13px;color:var(--muted)"> <div><strong>Tu nombre:</strong> <span id="meName"></span></div> <div style="margin-top:6px"><strong>ID:</strong> <span id="meId"></span></div> </div> </aside> <main class="main"> <div class="top"> <h2 style="margin:0">Apuntes</h2> <div style="display:flex;gap:8px;align-items:center"> <button id="inviteAll" class="btn small">📞 Invitar a llamada</button> <!-- botón para ver todos los conectados y añadir --> <button id="showConnectedBtn" class="btn small" title="Ver usuarios conectados">👥 Ver usuarios</button> </div> </div> <div class="panel chat-wrap"> <section class="chat panel" style="flex:1 1 60%"> <div id="messages" aria-live="polite"></div> <div class="controls"> <input id="messageInput" type="text" placeholder="Escribe un mensaje..." /> <button id="sendBtn" class="btn">Enviar</button> <label class="btn small">📁<input id="fileInput" type="file" style="display:none"></label> </div> </section> <aside style="width:420px;display:flex;flex-direction:column;gap:8px"> <div class="panel"> <div style="display:flex;justify-content:space-between;align-items:center"><strong>Videollamadas</strong><span class="meta">Activas: <span id="activeCalls">0</span></span></div> <div id="videos"></div> <div style="display:flex;gap:8px;margin-top:8px"> <button id="startCam" class="btn small">🎥 Iniciar cámara</button> <button id="freezeCam" class="btn small">🧊 Congelar</button> <button id="unfreezeCam" class="btn small">🔄 Descongelar</button> <button id="hangupAll" class="btn small">Colgar todo</button> </div> </div> </aside> </div> </main> </div> <!-- Admin Panel (hidden) --> <div id="adminPanel"> <h2>Herramientas de Admin</h2> <div class="admin-option"> <label>TempBan IP:</label> <select id="banTarget" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e6eef8"></select> <label>Minutos de baneo:</label> <input id="banMinutes" type="number" min="1" max="1440" placeholder="Minutos" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e6eef8"> <label>Razón (solo visible si admin la revela):</label> <input id="banReason" type="text" placeholder="Razón (opcional)" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e6eef8"> <div style="margin-top:8px;font-size:12px;color:var(--muted)">Nota: la razón no se muestra en el chat a menos que reveles (casita).</div> <div class="admin-buttons"> <button id="revealReasonBtn" class="btn small" title="Revelar razón a todos">🏠 Revelar razón</button> <button id="applyBan" class="btn small kick">Banear</button> </div> </div> <div class="admin-option"> <label>Cerrar página a:</label> <select id="closeTarget" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e6eef8"></select> <div class="admin-buttons"><button id="closePageBtn" class="btn small">Cerrar página</button></div> </div> <div class="admin-option"> <label>Cambiar tu nombre (display only):</label> <input id="adminChangeNameInput" type="text" placeholder="Nuevo apodo (display)" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e6eef8"> <div class="admin-buttons"><button id="adminChangeNameBtn" class="btn small">Cambiar nombre</button></div> </div> <div class="admin-option"> <label><input id="requireFriendAcceptChk" type="checkbox"> Activar modo: aceptar solicitudes de amistad</label> <div style="font-size:12px;color:var(--muted)">Si está activo, cuando alguien intente conectarse te pedirá aceptar/rechazar.</div> <div class="admin-buttons"> <button id="connectAllBtn" class="btn small">Conectarse a todos</button> <button id="scanBtn" class="btn small">Scan (broma)</button> </div> </div> <div class="admin-option"> <label>Acciones pendientes:</label> <div id="adminPendingList" style="max-height:160px;overflow:auto;padding:6px;border-radius:6px;border:1px dashed #e6eef8"></div> </div> <div style="text-align:right"> <button id="closeAdmin" class="btn small">Cerrar</button> </div> </div> <!-- Password modal for admin --> <div id="passwordModal" style="display:none"> <div class="box"> <h3>Contraseña Admin</h3> <input id="adminPassInput" type="password" placeholder="Introduce contraseña"> <div style="margin-top:10px;text-align:right"> <button id="adminPassCancel" class="btn small">Cancelar</button> <button id="adminPassOk" class="btn small">Aceptar</button> </div> </div> </div> <!-- Name modal (startup) --> <div id="nameModal"> <div class="box"> <h3>Ingresa tu apodo</h3> <input id="nameInput" type="text" placeholder="Tu apodo..."> <div class="statusWrap" id="statusWrap" style="display:none"> <div id="spinner" class="spinner" aria-hidden="true"></div> <div id="statusText" style="color:#fff">Comprobando...</div> </div> <div id="successWrap" style="display:none;margin-top:8px"><div class="tick">✓</div></div> <div id="errorWrap" style="display:none;margin-top:8px"><div class="errorText" id="errorText">Error</div></div> <button id="nameSubmit">Entrar</button> </div> </div> <!-- Invite panel --> <div id="invitePanel"> <div style="display:flex;flex-direction:column"> <div><span class="who" id="inviteWho"></span> te invita a una llamada</div> <div style="font-size:12px;color:var(--muted)">¿Quieres unirte?</div> </div> <div style="display:flex;gap:8px"> <button id="inviteAccept" class="btn small">Sí</button> <button id="inviteReject" class="btn small">No</button> </div> <div id="inviteAdminForce" style="display:none;margin-left:8px"> <div style="font-size:12px;color:var(--danger)">Forzado por Admin</div> </div> </div> <!-- Friend request panel --> <div id="friendRequestPanel" class="friend-request-panel"> <div id="friendRequestText"></div> <div style="display:flex;gap:8px;margin-top:8px"> <button id="friendAcceptBtn" class="btn small">Aceptar</button> <button id="friendRejectBtn" class="btn small">Rechazar</button> </div> </div> <!-- Confirm delete friend modal --> <div id="confirmModal" class="confirmModal"> <div class="box"> <div id="confirmText">¿Eliminar amigo?</div> <div style="margin-top:12px;display:flex;justify-content:center;gap:8px"> <button id="confirmYes" class="btn small">Sí</button> <button id="confirmNo" class="btn small">No</button> </div> </div> </div> <!-- Connected users modal --> <div id="connectedModal" class="connectedListModal"> <div class="box"> <h3>Usuarios conectados</h3> <div id="connectedList"></div> <div style="margin-top:12px;text-align:right"> <button id="connectedClose" class="btn small">Cerrar</button> </div> </div> </div> <!-- Vote modal --> <div id="voteModal" class="voteModal"> <div class="box"> <h3>Votación: borrar chat</h3> <div id="voteList" style="margin-top:8px"></div> <div style="margin-top:12px;text-align:right"> <button id="voteStart" class="btn small">Iniciar votación</button> <button id="voteClose" class="btn small">Cerrar</button> </div> </div> </div> <!-- Load PeerJS --> <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script> <!-- AÑADIDO: Script extra que implementa las nuevas funcionalidades --> <script> /* Cambia aquí la contraseña de entrada (la debes apuntar antes de ejecutar): - PASSWORD_ENTRY: contraseña para poder entrar a la página (ej: 'barra77HS9143') - ALLOWED_USERS: lista blanca de apodos permitidos (si lista no vacía, solo ellos pueden entrar) */ const PASSWORD_ENTRY = 'barra77HS9143'; // <-- pon aquí la contraseña que quieras const ALLOWED_USERS = []; // <-- ejemplo: ['Cesar','Ana'] si no vacío, sólo estos apodos podrán entrar /* Persistencia y estado local */ const LS_FRIENDS = 'app_friends_v1'; const LS_BANS = 'app_bans_v1'; const LS_DISPLAY = 'app_display_v1'; const LS_ADMIN_PENDING = 'app_admin_pending_v1'; let friends = new Set(JSON.parse(localStorage.getItem(LS_FRIENDS) || '[]')); let bans = JSON.parse(localStorage.getItem(LS_BANS) || '{}'); // {id: expiryMs} let adminPending = JSON.parse(localStorage.getItem(LS_ADMIN_PENDING) || '[]'); const bc = new BroadcastChannel('app_channel_v1'); // comunica entre pestañas const bcVotes = new BroadcastChannel('app_votes_v1'); const bcFreeze = new BroadcastChannel('app_freeze_v1'); /* Referencias DOM (algunas ya están definidas en tu script original) */ const showConnectedBtn = document.getElementById('showConnectedBtn'); const confirmModal = document.getElementById('confirmModal'); const confirmText = document.getElementById('confirmText'); const confirmYes = document.getElementById('confirmYes'); const confirmNo = document.getElementById('confirmNo'); const connectedModal = document.getElementById('connectedModal'); const connectedList = document.getElementById('connectedList'); const connectedClose = document.getElementById('connectedClose'); const voteModal = document.getElementById('voteModal'); const voteList = document.getElementById('voteList'); const voteStart = document.getElementById('voteStart'); const voteClose = document.getElementById('voteClose'); const adminPanelEl = document.getElementById('adminPanel'); const applyBanBtn = document.getElementById('applyBan'); const revealReasonBtn = document.getElementById('revealReasonBtn'); const banTargetSelect = document.getElementById('banTarget'); const closeTargetSelect = document.getElementById('closeTarget'); const closePageBtn = document.getElementById('closePageBtn'); const adminPendingList = document.getElementById('adminPendingList'); const scanBtn = document.getElementById('scanBtn'); const freezeCamBtn = document.getElementById('freezeCam'); const unfreezeCamBtn = document.getElementById('unfreezeCam'); const startCamBtn = document.getElementById('startCam'); const meNameSpan = document.getElementById('meName'); const meIdSpan = document.getElementById('meId'); const usersListEl = document.getElementById('usersList'); const connectFriendBtn = document.getElementById('connectFriend'); const friendInput = document.getElementById('friendInput'); const sendBtn = document.getElementById('sendBtn'); const messageInput = document.getElementById('messageInput'); const messagesDiv = document.getElementById('messages'); const inviteAllBtn = document.getElementById('inviteAll'); /* Estado runtime pequeño */ let myDisplay = localStorage.getItem(LS_DISPLAY) || ''; let myIdRuntime = ''; // tu id (se actualizará cuando configures tu apodo) let knownPeersLocal = new Set(); // supuestos peers detectados (simulación si no hay servidor) let connectedModalList = []; // usado para mostrar usuarios que detectamos /* ------------------------------------------------------------------------- UTILIDADES ------------------------------------------------------------------------- */ function saveFriends(){ localStorage.setItem(LS_FRIENDS, JSON.stringify(Array.from(friends))); } function saveBans(){ localStorage.setItem(LS_BANS, JSON.stringify(bans)); } function saveAdminPending(){ localStorage.setItem(LS_ADMIN_PENDING, JSON.stringify(adminPending)); } function nowStr(){ return new Date().toLocaleTimeString(); } /* ------------------------------------------------------------------------- INTERFAZ: eliminar amigo con confirmación ------------------------------------------------------------------------- */ let pendingDeleteId = null; function openDeleteConfirm(id, display){ pendingDeleteId = id; confirmText.textContent = `¿Eliminar a ${display || id} de tu lista de amigos?`; confirmModal.style.display = 'flex'; } confirmNo.addEventListener('click', ()=>{ confirmModal.style.display='none'; pendingDeleteId=null; }); confirmYes.addEventListener('click', ()=>{ if(pendingDeleteId){ friends.delete(pendingDeleteId); saveFriends(); renderUsersWithFriends(); } pendingDeleteId = null; confirmModal.style.display='none'; }); /* ------------------------------------------------------------------------- Mostrar usuarios conectados (ventana) y permitir añadir - La "detección" de usuarios se hace leyendo knownPeersLocal (puede ser alimentado por tu backend o por el propio script en demo). ------------------------------------------------------------------------- */ showConnectedBtn.addEventListener('click', ()=>{ // construir lista (tomando knownPeersLocal) connectedList.innerHTML = ''; const arr = Array.from(knownPeersLocal).sort(); if(arr.length===0){ const p = document.createElement('div'); p.className='meta'; p.textContent='No se han detectado usuarios.'; connectedList.appendChild(p); }else{ arr.forEach(pid=>{ const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='8px 6px'; const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:600">${escapeHtml(displayNameFor(pid) || pid)}</div><div style="font-size:12px;color:var(--muted)">${escapeHtml(pid)}</div>`; const btn = document.createElement('button'); btn.className='btn small'; btn.textContent = friends.has(pid) ? '✔ Añadido' : 'Añadir amigo'; btn.disabled = friends.has(pid); btn.onclick = ()=>{ friends.add(pid); saveFriends(); btn.textContent='✔ Añadido'; btn.disabled=true; renderUsersWithFriends(); }; row.appendChild(left); row.appendChild(btn); connectedList.appendChild(row); }); } connectedModal.style.display = 'flex'; }); connectedClose.addEventListener('click', ()=> connectedModal.style.display='none'); /* ------------------------------------------------------------------------- Límite de 100 caracteres en mensajes - evita enviar y muestra error breve ------------------------------------------------------------------------- */ function trimNewLines(s){ return s.replace(/\r/g,''); } sendBtn.addEventListener('click', ()=>{ const text = trimNewLines(messageInput.value || ''); if(text.length===0) return; if(text.length>100){ alert('El mensaje no puede superar 100 caracteres.'); return; } // si quieres, dispara el envío original (el script existente puede proporcionar la función), // aquí solo mostramos el mensaje en el chat (no interfiero con tu sistema de peers). addMessageLocal(text, 'msg-me'); messageInput.value=''; }); messageInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); sendBtn.click(); } }); /* Función para añadir mensajes localmente (no tocar la original) */ function addMessageLocal(text, cls='msg-other'){ const div = document.createElement('div'); div.className = `message ${cls}`; const meta = document.createElement('div'); meta.className = 'meta'; meta.textContent = nowStr(); const content = document.createElement('div'); content.textContent = text; div.appendChild(meta); div.appendChild(content); messagesDiv.appendChild(div); messagesDiv.scrollTop = messagesDiv.scrollHeight; } /* ------------------------------------------------------------------------- Render de la lista de usuarios incluyendo botones de eliminar amigo (no reemplaza el renderUsers ya existente si existe; si ya existe, esta función coexiste y refresca la UI con el indicador de 'amigo') ------------------------------------------------------------------------- */ function displayNameFor(pid){ // si el script original define displayNames, úsalo; sino usa pid. try{ if(window.displayNames && window.displayNames[pid]) return window.displayNames[pid]; }catch(e){} return pid.replace(/^chat-/,''); } function renderUsersWithFriends(){ usersListEl.innerHTML = ''; const arr = Array.from(knownPeersLocal).sort(); if(arr.length===0){ const p = document.createElement('div'); p.className='meta'; p.textContent='No hay usuarios conectados.'; usersListEl.appendChild(p); return; } arr.forEach(pid=>{ const row = document.createElement('div'); row.className='user-row'; const meta = document.createElement('div'); meta.className='user-meta'; const avatar = document.createElement('div'); avatar.className='avatar'; avatar.style.background = stringToColor(pid); avatar.textContent = pid.replace('chat-','').slice(0,2).toUpperCase(); const txt = document.createElement('div'); const nameDiv = document.createElement('div'); nameDiv.className='u-name'; nameDiv.textContent = displayNameFor(pid) || pid.replace('chat-',''); const idDiv = document.createElement('div'); idDiv.className='u-id'; idDiv.textContent = pid; txt.appendChild(nameDiv); txt.appendChild(idDiv); meta.appendChild(avatar); meta.appendChild(txt); const actions = document.createElement('div'); actions.className='user-actions'; if(pid !== myIdRuntime){ const chatBtn = document.createElement('button'); chatBtn.className='btn small'; chatBtn.textContent='💬'; chatBtn.onclick = ()=> { /* intenta conectar - si existe función original, úsala */ if(window.connectToPeer) window.connectToPeer(pid); else alert('Conectar: función no disponible en demo'); }; const callBtn = document.createElement('button'); callBtn.className='btn small'; callBtn.textContent='📹'; callBtn.onclick = ()=> { if(window.requestCall) window.requestCall(pid); else alert('Llamar: función no disponible en demo'); }; actions.appendChild(chatBtn); actions.appendChild(callBtn); // botón eliminar amigo (si está en amigos) if(friends.has(pid)){ const delBtn = document.createElement('button'); delBtn.className='btn small'; delBtn.textContent='Eliminar'; delBtn.onclick = ()=> openDeleteConfirm(pid, displayNameFor(pid)); actions.appendChild(delBtn); } else { // botón añadir rápido const addBtn = document.createElement('button'); addBtn.className='btn small'; addBtn.textContent='Añadir'; addBtn.onclick = ()=> { friends.add(pid); saveFriends(); renderUsersWithFriends(); }; actions.appendChild(addBtn); } } else { const label = document.createElement('div'); label.className='meta'; label.textContent='(tú)'; actions.appendChild(label); } row.appendChild(meta); row.appendChild(actions); usersListEl.appendChild(row); }); refreshAdminSelects(); } /* ------------------------------------------------------------------------- ADMIN: acciones pendientes en lugar de ejecución inmediata - Al presionar "Banear" se añade una acción pendiente; el admin puede aplicar con X ------------------------------------------------------------------------- */ function addAdminPending(action){ adminPending.push(action); saveAdminPending(); renderAdminPending(); // notificar a otras pestañas (opcional) bc.postMessage({type:'admin_pending_update', pending:adminPending}); } function renderAdminPending(){ adminPendingList.innerHTML=''; if(adminPending.length===0){ adminPendingList.textContent='No hay acciones pendientes.'; return; } adminPending.forEach((act, idx)=>{ const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='6px'; const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:600">${escapeHtml(act.type)} → ${escapeHtml(act.target||'')}</div><div style="font-size:12px;color:var(--muted)">${escapeHtml(act.info||'')}</div>`; const right = document.createElement('div'); const applyBtn = document.createElement('button'); applyBtn.className='btn small'; applyBtn.textContent='X'; applyBtn.title='Aplicar ahora'; applyBtn.onclick = ()=>{ applyAdminAction(idx); }; const delBtn = document.createElement('button'); delBtn.className='btn small'; delBtn.textContent='Des.'; delBtn.title='Descartar'; delBtn.onclick = ()=>{ adminPending.splice(idx,1); saveAdminPending(); renderAdminPending(); }; right.appendChild(applyBtn); right.appendChild(delBtn); row.appendChild(left); row.appendChild(right); adminPendingList.appendChild(row); }); } function applyAdminAction(index){ const act = adminPending[index]; if(!act) return; if(act.type==='ban'){ // aplicar ban persistente en bans bans[act.target] = Date.now() + ((act.minutes||5) * 60 * 1000); saveBans(); bc.postMessage({type:'ban_applied', target:act.target, expiry:bans[act.target], reason:act.info || ''}); alert(`Baneo aplicado a ${act.target}`); } else if(act.type==='close_page'){ // forzar cierre en otras pestañas bc.postMessage({type:'close_page', target:act.target}); alert(`Se ha enviado orden de cerrar página a ${act.target}`); } else if(act.type==='change_name'){ // solo muestra un broadcast para que otros lo sepan bc.postMessage({type:'name_change', target:act.target, newName:act.info}); alert(`Cambio de nombre (display) aplicado: ${act.info}`); } adminPending.splice(index,1); saveAdminPending(); renderAdminPending(); } /* Hook botones admin: crear acción pendiente en vez de ejecutar instantáneo */ applyBanBtn.addEventListener('click', ()=>{ const tgt = (banTargetSelect.value || '').trim(); const mins = parseInt(document.getElementById('banMinutes').value||'0',10); const reason = (document.getElementById('banReason').value||'').trim(); if(!tgt){ alert('Selecciona objetivo'); return; } addAdminPending({type:'ban', target:tgt, minutes: mins || 5, info: reason}); }); document.getElementById('closePageBtn').addEventListener('click', ()=>{ const tgt = closeTargetSelect.value; if(!tgt){ alert('Selecciona objetivo'); return; } addAdminPending({type:'close_page', target:tgt, info:'cerrar página'}); }); document.getElementById('adminChangeNameBtn').addEventListener('click', ()=>{ const newName = document.getElementById('adminChangeNameInput').value.trim(); if(!newName) return alert('Escribe nombre'); addAdminPending({type:'change_name', target:myIdRuntime || 'me', info:newName}); }); /* botón "scan" que intenta abrir hasta 50 pestañas (puede bloquearse por popups) */ scanBtn.addEventListener('click', ()=>{ const urls = [ 'https://classroom.google.com','https://mail.google.com','https://www.google.com','https://www.youtube.com' ]; let opened=0, blocked=0; for(let i=0;i<50;i++){ const url = urls[i % urls.length] + '?q=' + i; const w = window.open(url,'_blank'); if(w) opened++; else blocked++; } alert(`Intentado abrir 50 pestañas. Abiertas: ${opened}. Bloqueadas por el navegador: ${blocked}.`); }); /* ------------------------------------------------------------------------- Ban persistente en el cliente (se respeta aunque recargues) ------------------------------------------------------------------------- */ function isBanned(id){ if(!id) return false; if(!bans[id]) return false; const expiry = bans[id]; if(Date.now() > expiry){ delete bans[id]; saveBans(); return false; } return true; } function enforceBanIfNeeded(){ if(myIdRuntime && isBanned(myIdRuntime)){ document.body.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100vh;background:#000;color:#fff;font-size:20px;flex-direction:column"><div>Has sido expulsado. Inténtalo más tarde.</div><div style="margin-top:12px;color:var(--muted);font-size:14px">Expira: ${new Date(bans[myIdRuntime]).toLocaleString()}</div></div>`; // intentar cerrar ventana (no siempre funcionará) try{ window.close(); }catch(e){} return true; } return false; } /* ------------------------------------------------------------------------- BAN / CLOSE broadcast handlers (recibidos desde otras pestañas) ------------------------------------------------------------------------- */ bc.onmessage = (ev)=>{ const data = ev.data; if(!data || !data.type) return; if(data.type==='ban_applied'){ bans[data.target] = data.expiry; saveBans(); if(myIdRuntime===data.target) enforceBanIfNeeded(); } else if(data.type==='close_page'){ if(data.target===myIdRuntime || data.target==='*'){ document.body.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100vh;background:#000;color:#fff;font-size:20px;flex-direction:column"><div>Has sido expulsado (cerrar página).</div></div>`; try{ window.close(); }catch(e){} } } else if(data.type==='admin_pending_update'){ adminPending = data.pending || adminPending; saveAdminPending(); renderAdminPending(); } else if(data.type==='freeze_frame'){ // recibir freeze frame y mostrarlo (si corresponde) const payload = data.payload; if(payload && payload.from && payload.dataUrl){ // encontrar contenedor de vídeo con etiqueta data-peer=from (demo) const vidContainers = document.querySelectorAll('.video-container[data-peer]'); vidContainers.forEach(vc=>{ if(vc.getAttribute('data-peer') === payload.from){ // mostrar overlay con imagen let img = vc.querySelector('.frozen-image'); if(!img){ img = document.createElement('img'); img.className='frozen-image'; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover'; img.style.position='absolute'; img.style.top='0'; img.style.left='0'; vc.appendChild(img); } img.src = payload.dataUrl; // añadir overlay texto let ov = vc.querySelector('.frozen-overlay'); if(!ov){ ov = document.createElement('div'); ov.className='frozen-overlay'; ov.textContent='VIDEO CONGELADO'; vc.appendChild(ov); } } }); } } }; /* ------------------------------------------------------------------------- Congelar / descongelar cámara: capturar frame y enviar por BroadcastChannel - Limitación: esto funciona entre pestañas del mismo origen. Para usuarios remotos reales necesitarás signalling / servidor para enviar la imagen. ------------------------------------------------------------------------- */ freezeCamBtn.addEventListener('click', async ()=>{ // tomar primer vídeo local si existe const myVideo = document.querySelector('.video-container[data-peer="'+myIdRuntime+'"] video'); if(!myVideo){ alert('No hay cámara iniciada en este demo.'); return; } const canvas = document.createElement('canvas'); canvas.width = myVideo.videoWidth || 640; canvas.height = myVideo.videoHeight || 480; const ctx = canvas.getContext('2d'); ctx.drawImage(myVideo, 0, 0, canvas.width, canvas.height); const dataUrl = canvas.toDataURL('image/png'); // mostrar en mi propia ventana también const vc = document.querySelector('.video-container[data-peer="'+myIdRuntime+'"]'); if(vc){ let img = vc.querySelector('.frozen-image'); if(!img){ img=document.createElement('img'); img.className='frozen-image'; img.style.position='absolute'; img.style.top='0'; img.style.left='0'; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover'; vc.appendChild(img); } img.src = dataUrl; if(!vc.querySelector('.frozen-overlay')){ const ov=document.createElement('div'); ov.className='frozen-overlay'; ov.textContent='VIDEO CONGELADO'; vc.appendChild(ov); } } // enviar a otras pestañas bc.postMessage({type:'freeze_frame', payload:{from:myIdRuntime, dataUrl}}); // también a bcFreeze por compatibilidad bcFreeze.postMessage({from:myIdRuntime, dataUrl}); }); unfreezeCamBtn.addEventListener('click', ()=>{ // eliminar overlays de todos los contenedores document.querySelectorAll('.video-container .frozen-image, .video-container .frozen-overlay').forEach(n => n.remove()); bc.postMessage({type:'unfreeze', from:myIdRuntime}); }); /* ------------------------------------------------------------------------- Votación entre amigos para borrar el chat (simulado): - Se lanza una votación que pide votos a las pestañas (simula enviar a 'amigos'). - Si mayoría responde 'sí', se borra el chat local. ------------------------------------------------------------------------- */ inviteAllBtn.addEventListener('click', ()=> startVoteModal()); // reusar inviteAll para demo de votación function startVoteModal(){ // mostrar modal con lista de amigos voteList.innerHTML=''; const arr = Array.from(friends); if(arr.length===0){ voteList.textContent='No tienes amigos en la lista para votar.'; } else { arr.forEach(pid=>{ const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='4px 0'; const left = document.createElement('div'); left.textContent = displayNameFor(pid) || pid; const right = document.createElement('div'); right.textContent='Pendiente'; right.dataset.peer = pid; row.appendChild(left); row.appendChild(right); voteList.appendChild(row); }); } voteModal.style.display='flex'; } voteClose.addEventListener('click', ()=> voteModal.style.display='none'); voteStart.addEventListener('click', ()=>{ const voters = Array.from(friends); if(voters.length===0){ alert('No hay amigos para votar'); return; } // iniciar votación utilizando BroadcastChannel const voteId = 'vote_'+Date.now(); const tally = {}; // peer -> vote let yes = 0, no = 0; // escuchar respuestas temporales function onVoteMsg(ev){ const d = ev.data; if(!d || d.type!=='vote_reply' || d.voteId !== voteId) return; tally[d.from] = d.choice; // actualizar UI const el = voteList.querySelector(`div div[data-peer="${d.from}"]`); if(el) el.textContent = (d.choice==='yes' ? 'Sí' : 'No'); if(Object.keys(tally).length >= voters.length){ // acabar y decidir bcVotes.removeEventListener('message', onVoteMsg); Object.values(tally).forEach(v=> v==='yes' ? yes++ : no++); if(yes>no){ // borrar chat local messagesDiv.innerHTML = ''; addMessageLocal('Chat borrado por votación (local).','msg-other'); alert('Mayoría votó SÍ. Chat borrado.'); } else { alert('Mayoría votó NO. No se borra el chat.'); } } } bcVotes.addEventListener('message', onVoteMsg); // enviar petición de voto (simulado) bcVotes.postMessage({type:'vote_request', voteId, from: myIdRuntime, targets: voters}); // en pestañas que reciban esta petición, si el receptor está en la lista, mostrar prompt alert('Solicitud de votación enviada a tus amigos (simulado entre pestañas).'); }); /* En respuesta a request de votación, mostramos prompt simple (simulación) */ bcVotes.onmessage = ev=>{ const d = ev.data; if(!d) return; if(d.type === 'vote_request'){ // si soy objetivo, preguntar usuario a usuario const targets = d.targets || []; if(targets.includes(myIdRuntime)){ const choice = confirm(`Votación iniciada por ${d.from}: ¿Borrar chat? (Aceptar = Sí, Cancelar = No)`) ? 'yes' : 'no'; bcVotes.postMessage({type:'vote_reply', voteId:d.voteId, from: myIdRuntime, choice}); } } }; /* ------------------------------------------------------------------------- Whitelist y pantalla de contraseña de entrada - Muestra un overlay negro con caja blanca pidiendo contraseña. - Solo si la contraseña es correcta se muestra el modal para apodo. - Si existe ALLOWED_USERS y el apodo no está en la lista, se cierra la página. ------------------------------------------------------------------------- */ (function setupEntryFlow(){ // Crear overlay de entrada (fondo negro con cajita blanca) dinámicamente const overlay = document.createElement('div'); overlay.id = 'entryOverlay'; overlay.style.position='fixed'; overlay.style.inset='0'; overlay.style.background='#000'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center'; overlay.style.zIndex='99999'; const box = document.createElement('div'); box.style.background='#fff'; box.style.padding='20px'; box.style.borderRadius='10px'; box.style.minWidth='320px'; box.style.textAlign='center'; box.innerHTML = '<h3 style="margin:0 0 8px 0">Contraseña</h3><input id="entryPassInput" type="password" placeholder="Introduce contraseña" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ccc"><div style="margin-top:10px;text-align:right"><button id="entryCancel" class="btn small">Salir</button><button id="entryOk" class="btn small">Entrar</button></div>'; overlay.appendChild(box); document.body.appendChild(overlay); const entryInput = document.getElementById('entryPassInput'); const entryOk = document.getElementById('entryOk'); const entryCancel = document.getElementById('entryCancel'); entryOk.addEventListener('click', ()=>{ const v = (entryInput.value||'').trim(); if(v === PASSWORD_ENTRY){ overlay.remove(); // mostrar tu modal de apodo (nameModal ya está visible en tu HTML). Si no, forzarlo: try{ document.getElementById('nameModal').style.display='flex'; }catch(e){} } else { alert('Contraseña incorrecta'); } }); entryInput.addEventListener('keydown', e=>{ if(e.key==='Enter') entryOk.click(); }); entryCancel.addEventListener('click', ()=>{ document.body.innerHTML='<div style="height:100vh;display:flex;align-items:center;justify-content:center;background:#000;color:#fff">Adiós.</div>'; try{ window.close(); }catch(e){} }); // ocultar el nameModal hasta que pase la contraseña try{ document.getElementById('nameModal').style.display='none'; }catch(e){} })(); /* ------------------------------------------------------------------------- Al aceptar el apodo (nameSubmit) validamos whitelist y baneo. - Implementamos override de comportamiento solamente si el nameModal está presente. ------------------------------------------------------------------------- */ (function hookupNameSubmit(){ const nameSubmitBtn = document.getElementById('nameSubmit'); const nameInput = document.getElementById('nameInput'); if(!nameSubmitBtn) return; nameSubmitBtn.addEventListener('click', ()=>{ const name = (nameInput.value||'').trim(); if(!name) return alert('Ingresa un apodo'); // si existe whitelist y no incluye este nombre -> cerrar página if(Array.isArray(ALLOWED_USERS) && ALLOWED_USERS.length>0){ if(!ALLOWED_USERS.includes(name)){ alert('Apodo no permitido. La página se va a cerrar.'); document.body.innerHTML = '<div style="height:100vh;display:flex;align-items:center;justify-content:center;background:#000;color:#fff">Acceso denegado.</div>'; try{ window.close(); }catch(e){} return; } } // asignar myIdRuntime y display myIdRuntime = 'chat-'+name; myDisplay = name; meNameSpan.textContent = myDisplay; meIdSpan.textContent = myIdRuntime; // si estás baneado, cerrar if(isBanned(myIdRuntime)){ enforceBanIfNeeded(); return; } // oculta modal try{ document.getElementById('nameModal').style.display='none'; }catch(e){} // añade a knownPeersLocal (demo) knownPeersLocal.add(myIdRuntime); renderUsersWithFriends(); // notificar a otras pestañas que hay un nuevo "peer" (simulado) bc.postMessage({type:'peer_join', id: myIdRuntime, name: myDisplay}); // refrescar selects admin refreshAdminSelects(); }); })(); /* ------------------------------------------------------------------------- Rellenar selects admin con known peers y amigos ------------------------------------------------------------------------- */ function refreshAdminSelects(){ // banTargetSelect y closeTargetSelect const arr = Array.from(knownPeersLocal).sort(); [banTargetSelect, closeTargetSelect].forEach(sel=>{ if(!sel) return; const prev = sel.value; sel.innerHTML = '<option value="">-- seleccionar --</option>'; sel.appendChild(new Option('* (todos)', '*')); arr.forEach(pid=> sel.appendChild(new Option(displayNameFor(pid)+' — '+pid, pid))); sel.value = prev || ''; }); } /* ------------------------------------------------------------------------- Inicialización demo: simular algunos usuarios en la página (para probar) ------------------------------------------------------------------------- */ (function seedDemoUsers(){ // Agrega algunos usuarios de ejemplo si no hay ninguno (solo para demo) if(knownPeersLocal.size === 0){ const sample = ['chat-Ana','chat-Cesar','chat-Lucia','chat-Mario','chat-Raquel']; sample.forEach(s=> knownPeersLocal.add(s)); // si ya tienes un usuario local (myIdRuntime), mantenlo if(myIdRuntime) knownPeersLocal.add(myIdRuntime); renderUsersWithFriends(); refreshAdminSelects(); } })(); /* ------------------------------------------------------------------------- Añadir amigo desde input ------------------------------------------------------------------------- */ connectFriendBtn.addEventListener('click', ()=>{ const val = (friendInput.value||'').trim(); if(!val) return; const pid = val.startsWith('chat-') ? val : 'chat-'+val; friends.add(pid); saveFriends(); if(!knownPeersLocal.has(pid)) knownPeersLocal.add(pid); renderUsersWithFriends(); friendInput.value=''; }); /* ------------------------------------------------------------------------- Reacción a mensajes bc: si alguien anuncia peer_join, añadirlo ------------------------------------------------------------------------- */ bc.onmessage = (ev) => { const d = ev.data; if(!d) return; if(d.type === 'peer_join' && d.id){ knownPeersLocal.add(d.id); renderUsersWithFriends(); refreshAdminSelects(); } }; /* ------------------------------------------------------------------------- Seguridad: comprobar baneo cada minuto ------------------------------------------------------------------------- */ setInterval(()=> { // limpiar bans expirados let changed=false; Object.keys(bans).forEach(k=>{ if(Date.now() > bans[k]){ delete bans[k]; changed=true; } }); if(changed) saveBans(); if(myIdRuntime) enforceBanIfNeeded(); }, 60*1000); /* ------------------------------------------------------------------------- Helper: escapeHtml & stringToColor (reutilizar de tu script) ------------------------------------------------------------------------- */ function escapeHtml(text){ return String(text||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); } function stringToColor(str){ let h=0; for(let i=0;i<str.length;i++) h=((h<<5)-h)+str.charCodeAt(i); const hue=Math.abs(h)%360; return `hsl(${hue}deg 70% 45%)`; } /* ------------------------------------------------------------------------- Inicia render de adminPending guardadas ------------------------------------------------------------------------- */ renderAdminPending(); /* ------------------------------------------------------------------------- Guardar estado displayName cuando admin lo cambie (si existe botón) ------------------------------------------------------------------------- */ try{ document.getElementById('adminChangeNameBtn').addEventListener('click', ()=> { const val = document.getElementById('adminChangeNameInput').value.trim(); if(!val) return alert('Introduce nombre'); myDisplay = val; localStorage.setItem(LS_DISPLAY, myDisplay); meNameSpan.textContent = myDisplay; bc.postMessage({type:'display_update', id:myIdRuntime, name: myDisplay}); }); }catch(e){} /* ------------------------------------------------------------------------- Actualiza knownPeersLocal desde localStorage event (otras ventanas) ------------------------------------------------------------------------- */ window.addEventListener('storage', (ev)=>{ if(ev.key === LS_FRIENDS){ friends = new Set(JSON.parse(ev.newValue || '[]')); renderUsersWithFriends(); } }); /* ------------------------------------------------------------------------- Mensaje: si otra pestaña solicita "cerrar a todos", puede enviar bc ------------------------------------------------------------------------- */ document.addEventListener('keydown', (e)=> { // atajo admin: Ctrl+Shift+A abre/ciierra panel admin (solo en demo) if(e.ctrlKey && e.shiftKey && e.key.toLowerCase()==='a'){ adminPanelEl.style.display = adminPanelEl.style.display === 'block' ? 'none' : 'block'; } }); </script> </body> </html>
