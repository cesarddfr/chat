<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Classroom</title>
  <style>
    body { font-family: sans-serif; background: #f5f5f5; padding: 10px; }
    #chat { border: 1px solid #ccc; background: #fff; height: 250px; overflow-y: auto; margin-bottom: 8px; padding: 5px; }
    input, button { padding: 5px; margin: 3px; }
    #friends { margin-bottom: 10px; }
    .hidden { display: none; }
    video { width: 200px; height: 150px; background: black; margin: 5px; position: relative; }
    #videos { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; }
    .video-container {
      position: relative;
      display: inline-block;
      border: 2px solid transparent;
      border-radius: 4px;
      overflow: hidden;
      background: black;
    }
    .video-label {
      position: absolute;
      top: 3px;
      left: 5px;
      background: rgba(0,0,0,0.5);
      color: #fff;
      padding: 2px 5px;
      font-size: 12px;
      border-radius: 3px;
      user-select: none;
      pointer-events: none;
    }
    .kick-btn {
      position: absolute;
      top: 3px;
      right: 5px;
      background: rgba(255, 0, 0, 0.8);
      border: none;
      color: white;
      font-weight: bold;
      cursor: pointer;
      font-size: 14px;
      border-radius: 3px;
      padding: 0 6px;
      display: none;
      user-select: none;
    }
    .video-container.admin .kick-btn {
      display: block;
    }
    #localVideo {
      border: 2px solid green;
    }
  </style>
</head>
<body>
  <h2>Classroom</h2>

  <div id="userInfo"></div>

  <div id="friends">
    <input type="text" id="friendName" placeholder="Nombre del amigo" />
    <button id="addFriendBtn">A√±adir amigo</button>
  </div>

  <div id="friendList"></div>

  <div id="chat"></div>

  <input type="text" id="messageInput" placeholder="Mensaje" />
  <button id="sendBtn">Enviar</button>

  <input type="file" id="fileInput" class="hidden" />
  <button id="sendFileBtn">üìÅ Enviar archivo</button>

  <div id="devControls" class="hidden">
    <button id="clearChatBtn">üóë Borrar conversaci√≥n (para todos)</button>
    <button id="panicBtn">‚ö†Ô∏è Bot√≥n del p√°nico</button>
    <button id="groupCallBtn">üìû Videollamada grupal</button>
  </div>

  <br />
  <button id="devModeBtn">Modo Admin</button>

  <hr />

  <h3>Videollamada</h3>
  <div id="videos">
    <div class="video-container" id="localVideoContainer">
      <video id="localVideo" autoplay muted></video>
      <div class="video-label" id="label-local">T√∫</div>
    </div>
    <!-- Aqu√≠ se a√±adir√°n din√°micamente los videos remotos -->
  </div>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    const PASSWORD = "0011"; // Contrase√±a fija para modo admin
    const userName = prompt("Pon tu nombre (√∫nico para este chat):") || ("user" + Math.floor(Math.random() * 1000));
    const myId = `chat-${userName}`;
    document.getElementById("userInfo").textContent = `Tu nombre: ${userName} (ID: ${myId})`;

    const peer = new Peer(myId);
    const connections = {};  // conexiones de chat
    const calls = {};        // llamadas activas por peerId
    let localStream = null;

    const chatDiv = document.getElementById("chat");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const friendList = document.getElementById("friendList");
    const fileInput = document.getElementById("fileInput");
    const sendFileBtn = document.getElementById("sendFileBtn");

    const clearChatBtn = document.getElementById("clearChatBtn");
    const panicBtn = document.getElementById("panicBtn");
    const devControls = document.getElementById("devControls");
    const devModeBtn = document.getElementById("devModeBtn");
    const groupCallBtn = document.getElementById("groupCallBtn");

    const videosDiv = document.getElementById("videos");
    const localVideo = document.getElementById("localVideo");
    const localVideoContainer = document.getElementById("localVideoContainer");

    let adminMode = false;

    // Funci√≥n para a√±adir mensajes al chat
    function addMessage(msg) {
      const p = document.createElement("p");
      p.textContent = msg;
      chatDiv.appendChild(p);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    // Limpiar chat local
    function clearChatLocal() {
      chatDiv.innerHTML = "";
    }

    // Funci√≥n bot√≥n p√°nico: cierra la p√°gina y redirige
    function activatePanic() {
      document.body.innerHTML = "<h1>üö® Emergencia. P√°gina cerrada. üö®</h1>";
      setTimeout(() => location.href = "https://classroom.google.com", 800);
    }

    // Crear control de amigo en la lista amigos
    function addFriendControl(friendId) {
      // Evitar a√±adir amigo duplicado
      if(document.getElementById(`friend-${friendId}`)) return;

      const container = document.createElement("div");
      container.id = `friend-${friendId}`;
      container.style.marginBottom = "5px";

      const label = document.createElement("span");
      label.textContent = `Conectado con ${friendId.replace("chat-", "")} `;

      const callBtn = document.createElement("button");
      callBtn.textContent = "üìπ Videollamada";
      callBtn.onclick = () => startCall(friendId);

      const removeFriendBtn = document.createElement("button");
      removeFriendBtn.textContent = "Eliminar amigo";
      removeFriendBtn.onclick = () => {
        if (confirm(`¬øQuieres eliminar a ${friendId.replace("chat-", "")} de tus amigos?`)) {
          // Cerrar conexi√≥n y eliminar de lista
          connections[friendId]?.close();
          delete connections[friendId];
          document.getElementById(`friend-${friendId}`)?.remove();
          addMessage(`‚ùå Has eliminado a ${friendId.replace("chat-", "")} de tus amigos.`);
          // Adem√°s si hay llamada activa, cerrarla
          if (calls[friendId]) {
            calls[friendId].close();
            delete calls[friendId];
            removeRemoteVideo(friendId);
          }
        }
      };

      container.appendChild(label);
      container.appendChild(callBtn);
      container.appendChild(removeFriendBtn);
      friendList.appendChild(container);

      // Mostrar botones extras solo en modo admin
      if (adminMode) {
        callBtn.style.marginRight = "5px";
        removeFriendBtn.style.marginLeft = "5px";
      } else {
        removeFriendBtn.style.display = "none";
      }
    }

    // Actualizar los botones "Eliminar amigo" y "Videollamada" seg√∫n modo admin
    function updateFriendListButtons() {
      Object.keys(connections).forEach(friendId => {
        const container = document.getElementById(`friend-${friendId}`);
        if (!container) return;
        const buttons = container.getElementsByTagName("button");
        for (const btn of buttons) {
          if (btn.textContent === "Eliminar amigo") {
            btn.style.display = adminMode ? "inline-block" : "none";
          }
        }
      });
    }

    // Configurar nueva conexi√≥n entrante o saliente
    function setupConnection(conn) {
      connections[conn.peer] = conn;
      addFriendControl(conn.peer);

      conn.on("data", data => {
        if (data.type === "expulsionCam") {
          // Apagar c√°mara local si se recibe expulsi√≥n
          stopLocalCamera();
          addMessage("‚ùå Has sido expulsado de la videollamada por el admin.");
        } else if (data.type === "clearChat") {
          clearChatLocal();
          addMessage("üóë Admin borr√≥ el chat.");
        } else if (data.type === "panic") {
          activatePanic();
        } else if (data.type === "file") {
          const link = document.createElement("a");
          link.href = data.url;
          link.download = data.fileName;
          link.textContent = `üìé Archivo recibido: ${data.fileName}`;
          const p = document.createElement("p");
          p.appendChild(link);
          chatDiv.appendChild(p);
          chatDiv.scrollTop = chatDiv.scrollHeight;
        } else if (data.type === "groupCall") {
          startCall(conn.peer);
        } else if (data.name && data.text) {
          addMessage(`${data.name}: ${data.text}`);
        }
      });

      conn.on("close", () => {
        delete connections[conn.peer];
        document.getElementById(`friend-${conn.peer}`)?.remove();
        addMessage(`‚ùå ${conn.peer.replace("chat-", "")} se ha desconectado.`);
        // Cerrar llamada si hay
        if (calls[conn.peer]) {
          calls[conn.peer].close();
          delete calls[conn.peer];
          removeRemoteVideo(conn.peer);
        }
      });

      addMessage(`üîî Conectado con ${conn.peer.replace("chat-", "")}`);

      updateFriendListButtons();
    }

    // Detener c√°mara local y limpiar video local
    function stopLocalCamera() {
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
      localVideo.srcObject = null;
    }

    // Funci√≥n para remover video remoto seg√∫n peerId
    function removeRemoteVideo(peerId) {
      const videoContainer = document.getElementById(`videoContainer-${peerId}`);
      if (videoContainer) {
        videoContainer.remove();
      }
    }

    // A√±adir video remoto din√°micamente
    function addRemoteVideo(peerId, labelName) {
      if(document.getElementById(`videoContainer-${peerId}`)) return; // evitar duplicados

      const container = document.createElement("div");
      container.className = "video-container" + (adminMode ? " admin" : "");
      container.id = `videoContainer-${peerId}`;

      const video = document.createElement("video");
      video.autoplay = true;
      video.id = `remoteVideo-${peerId}`;
      video.classList.add("remote");
      video.style.backgroundColor = "black";

      const label = document.createElement("div");
      label.className = "video-label";
      label.textContent = labelName;

      // Bot√≥n para expulsar c√°mara
      const kickBtn = document.createElement("button");
      kickBtn.className = "kick-btn";
      kickBtn.textContent = "X";
      kickBtn.title = `Expulsar c√°mara de ${labelName}`;
      kickBtn.onclick = () => {
        if (!adminMode) return alert("Solo el admin puede expulsar c√°maras.");
        if (confirm(`¬øQuieres expulsar la c√°mara de ${labelName}?`)) {
          if (connections[peerId]) {
            connections[peerId].send({ type: "expulsionCam" });
            addMessage(`‚ö†Ô∏è Has expulsado la c√°mara de ${labelName}`);
            // No cerramos la conexi√≥n, solo dejamos la c√°mara apagada en remoto
            // Tambi√©n removemos el video local del admin para reflejarlo
            removeRemoteVideo(peerId);
          }
        }
      };

      container.appendChild(video);
      container.appendChild(label);
      container.appendChild(kickBtn);
      videosDiv.appendChild(container);
    }

    // Funci√≥n para iniciar llamada a un amigo
    async function startCall(friendId) {
      if (!localStream) {
        try {
          localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
          localVideo.srcObject = localStream;
        } catch (e) {
          alert("No se pudo acceder a la c√°mara o micr√≥fono: " + e);
          return;
        }
      }

      // Si ya hay llamada con ese peer, cerrar para reiniciar
      if (calls[friendId]) {
        calls[friendId].close();
        delete calls[friendId];
        removeRemoteVideo(friendId);
      }

      const call = peer.call(friendId, localStream);
      calls[friendId] = call;

      // Crear espacio video remoto
      addRemoteVideo(friendId, friendId.replace("chat-", ""));

      call.on("stream", remoteStream => {
        const video = document.getElementById(`remoteVideo-${friendId}`);
        if (video) {
          video.srcObject = remoteStream;
        }
      });

      call.on("close", () => {
        removeRemoteVideo(friendId);
        addMessage(`üì¥ La videollamada con ${friendId.replace("chat-", "")} termin√≥.`);
        delete calls[friendId];
      });

      addMessage(`üìπ Llamando a ${friendId.replace("chat-", "")}...`);
    }

    // Recibir llamada entrante
    peer.on("call", async call => {
      if (!localStream) {
        try {
          localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
          localVideo.srcObject = localStream;
        } catch (e) {
          alert("No se pudo acceder a la c√°mara o micr√≥fono para responder la llamada: " + e);
          call.close();
          return;
        }
      }

      call.answer(localStream);
      calls[call.peer] = call;

      // A√±adir video remoto para quien llama
      addRemoteVideo(call.peer, call.peer.replace("chat-", ""));

      call.on("stream", remoteStream => {
        const video = document.getElementById(`remoteVideo-${call.peer}`);
        if (video) {
          video.srcObject = remoteStream;
        }
      });

      call.on("close", () => {
        removeRemoteVideo(call.peer);
        addMessage(`üì¥ La videollamada con ${call.peer.replace("chat-", "")} termin√≥.`);
        delete calls[call.peer];
      });

      addMessage(`üìπ Recibida llamada de ${call.peer.replace("chat-", "")}`);
    });

    // Listener cuando el peer se conecta
    peer.on("open", () => {
      addMessage("‚úÖ Tu ID es " + myId);
    });

    // Cuando recibimos una conexi√≥n
    peer.on("connection", conn => {
      setupConnection(conn);
    });

    // Bot√≥n a√±adir amigo: crea conexi√≥n
    document.getElementById("addFriendBtn").onclick = () => {
      const friendNameVal = document.getElementById("friendName").value.trim();
      if (!friendNameVal) return alert("Introduce el nombre del amigo.");
      const friendId = "chat-" + friendNameVal;
      if (friendId === myId) return alert("No te puedes a√±adir a ti mismo.");

      if (connections[friendId]) {
        alert("Ya est√°s conectado con ese amigo.");
        return;
      }

      const conn = peer.connect(friendId);
      conn.on("open", () => {
        setupConnection(conn);
        addMessage(`‚úÖ Conexi√≥n establecida con ${friendNameVal}`);
      });
      conn.on("error", err => {
        alert("Error al conectar con " + friendNameVal + ": " + err);
      });
    };

    // Enviar mensaje de texto a todos amigos
    sendBtn.onclick = () => {
      const text = messageInput.value.trim();
      if (!text) return;
      Object.values(connections).forEach(conn => {
        conn.send({ name: userName, text });
      });
      addMessage(`T√∫: ${text}`);
      messageInput.value = "";
    };

    // Enviar archivo: abrir selector
    sendFileBtn.onclick = () => {
      fileInput.click();
    };

    // Enviar archivo a todos
    fileInput.onchange = () => {
      const file = fileInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const base64data = reader.result;
        Object.values(connections).forEach(conn => {
          conn.send({ type: "file", url: base64data, fileName: file.name });
        });
        addMessage(`üìÅ Has enviado el archivo: ${file.name}`);
      };
      reader.readAsDataURL(file);
      fileInput.value = "";
    };

    // Bot√≥n modo admin: pide contrase√±a
    devModeBtn.onclick = () => {
      if (!adminMode) {
        const pwd = prompt("Introduce la contrase√±a de admin:");
        if (pwd === PASSWORD) {
          adminMode = true;
          devControls.classList.remove("hidden");
          devModeBtn.textContent = "Salir modo Admin";
          updateFriendListButtons();
          localVideoContainer.classList.add("admin");
          addMessage("üîê Modo admin activado.");
        } else {
          alert("Contrase√±a incorrecta.");
        }
      } else {
        adminMode = false;
        devControls.classList.add("hidden");
        devModeBtn.textContent = "Modo Admin";
        updateFriendListButtons();
        localVideoContainer.classList.remove("admin");
        addMessage("üîì Modo admin desactivado.");
      }
    };

    // Borrar conversaci√≥n (admin)
    clearChatBtn.onclick = () => {
      if (!adminMode) return alert("Solo el admin puede borrar el chat.");
      clearChatLocal();
      // Avisar a todos amigos
      Object.values(connections).forEach(conn => {
        conn.send({ type: "clearChat" });
      });
      addMessage("üóë Has borrado la conversaci√≥n para todos.");
    };

    // Bot√≥n p√°nico (admin)
    panicBtn.onclick = () => {
      if (!adminMode) return alert("Solo el admin puede activar el bot√≥n del p√°nico.");
      Object.values(connections).forEach(conn => {
        conn.send({ type: "panic" });
      });
      activatePanic();
    };

    // Bot√≥n videollamada grupal (admin)
    groupCallBtn.onclick = () => {
      if (!adminMode) return alert("Solo el admin puede iniciar videollamada grupal.");
      Object.keys(connections).forEach(peerId => {
        startCall(peerId);
      });
      addMessage("üìû Videollamada grupal iniciada.");
    };

    // Cuando alguien se conecta con nosotros se a√±ade video si hay llamada activa
    // (opcional: para sincronizar estados, pero no obligatorio)

    // Cuando la p√°gina se cierra, cerrar todas conexiones
    window.onbeforeunload = () => {
      Object.values(connections).forEach(conn => conn.close());
      Object.values(calls).forEach(call => call.close());
      stopLocalCamera();
      peer.destroy();
    };
  </script>
</body>
</html>
