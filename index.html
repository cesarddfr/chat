<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Chat P2P Avanzado</title>
<style>
  /* Mantener el CSS original, no se toca la estética */
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar panel">
    <h3>Conectar por Apodo</h3>
    <input id="peerIdInput" type="text" placeholder="Escribe el apodo..."/>
    <button id="connectBtn" class="btn small">Conectar</button>
    <h3>Historial de Chats</h3>
    <div id="chatHistory" style="overflow:auto;max-height:200px;"></div>
  </aside>

  <main class="main">
    <div class="top">
      <h2>Chat P2P Avanzado</h2>
      <button id="startCamBtn" class="btn small">Iniciar cámara</button>
    </div>

    <div class="panel chat-wrap">
      <section class="chat panel" style="flex:1 1 60%">
        <div id="messages" aria-live="polite"></div>
        <div class="controls">
          <input id="messageInput" type="text" placeholder="Escribe un mensaje..." />
        </div>
      </section>
      <aside style="width:420px;display:flex;flex-direction:column;gap:8px">
        <div id="videos"></div>
        <div id="adminPanel" style="display:none;flex-direction:column;gap:4px;">
          <button id="kickBtn">Kick</button>
          <button id="banBtn">Ban</button>
          <button id="tempBanBtn">TempBan</button>
          <button id="tempBanIPBtn">TempBanIP</button>
          <button id="closeAdmin">Cerrar Panel</button>
        </div>
      </aside>
    </div>
  </main>
</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
const userName = prompt('Pon tu nombre:') || 'user'+Math.floor(Math.random()*1000);
const myId = 'chat-'+userName;

const peer = new Peer(myId);
const dataConns = {};
const mediaCalls = {};
let localStream = null;
let chatHistoryArr = [];

const peerIdInput = document.getElementById('peerIdInput');
const connectBtn = document.getElementById('connectBtn');
const messagesDiv = document.getElementById('messages');
const messageInput = document.getElementById('messageInput');
const videosDiv = document.getElementById('videos');
const startCamBtn = document.getElementById('startCamBtn');
const chatHistory = document.getElementById('chatHistory');
const adminPanel = document.getElementById('adminPanel');

// -------------------- UTILIDADES --------------------
function addMessage(text, cls='msg-other'){
  const div = document.createElement('div');
  div.className = `message ${cls}`;
  div.textContent = text;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function updateHistory(peerName, peerId){ 
  if(!chatHistoryArr.find(e=>e.id===peerId)){
    chatHistoryArr.push({name:peerName,id:peerId});
    renderHistory();
  }
}

function renderHistory(){
  chatHistory.innerHTML='';
  chatHistoryArr.forEach(e=>{
    const div = document.createElement('div');
    div.textContent = e.name+' ';
    const btn = document.createElement('button');
    btn.textContent='Reconectar';
    btn.onclick = ()=>connectToPeer(e.name);
    div.appendChild(btn);
    chatHistory.appendChild(div);
  });
}

// -------------------- CONEXIONES --------------------
function connectToPeer(targetName){
  const target = targetName.startsWith('chat-')?targetName:'chat-'+targetName;
  if(target===myId){ alert('No puedes conectarte a ti mismo'); return; }
  if(dataConns[target]){ alert('Ya conectado'); return; }

  const conn = peer.connect(target, {reliable:true});
  conn.on('open', ()=>{
    setupConn(conn);
    peerIdInput.value=''; // vaciar el campo automáticamente
  });
  conn.on('error', e=>alert('Error: '+e));
}

function setupConn(conn){
  dataConns[conn.peer]=conn;
  conn.on('data', data=>handleData(conn.peer,data));
  conn.on('close', ()=>{
    delete dataConns[conn.peer];
    removeRemoteVideo(conn.peer);
    addMessage(`⚠️ ${conn.peer.replace('chat-','')} se desconectó`);
  });
  try{ conn.send({type:'join',id:myId,name:userName}); }catch(e){}
  updateHistory(conn.peer.replace('chat-',''), conn.peer);
}

connectBtn.onclick = ()=>{ 
  const targetName = peerIdInput.value.trim();
  if(!targetName){ alert('Apodo inválido'); return; } 
  connectToPeer(targetName); 
};

// Presionar Enter para conectar
peerIdInput.addEventListener('keyup', e=>{
  if(e.key==='Enter'){ connectBtn.click(); }
});

// -------------------- MENSAJES --------------------
messageInput.addEventListener('keyup', e=>{
  if(e.key==='Enter'){ sendMessage(); }
});

function sendMessage(){
  const text = messageInput.value.trim();
  if(!text) return;
  if(text==='/admintools0011'){ adminPanel.style.display='flex'; messageInput.value=''; return; }
  addMessage('Tú: '+text,'msg-me');
  for(const k in dataConns){ try{ dataConns[k].send({type:'chat',name:userName,text}); }catch(e){} }
  messageInput.value='';
}

// -------------------- RECEPCIÓN --------------------
function handleData(from, data){
  if(!data) return;
  if(data.type==='join'){ updateHistory(data.name,data.id); addMessage(`${data.name} se ha unido`); }
  else if(data.type==='chat'){ addMessage(data.name+': '+data.text,'msg-other'); }
  else if(data.type==='camRequest'){
    const accept = confirm(from.replace('chat-','')+' quiere iniciar cámara. Aceptas?');
    if(accept) startCall(from);
  }
  else if(data.type==='ban'){ addMessage('⛔ Has sido baneado por admin'); location.reload(); }
}

// -------------------- CAMARA --------------------
startCamBtn.onclick=()=>{
  const targets = Object.keys(dataConns);
  if(targets.length===0){ alert('Conéctate primero'); return; }
  targets.forEach(t=>{
    dataConns[t].send({type:'camRequest',from:myId});
  });
};

async function startCall(pid){
  try{
    if(!localStream) localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    const call = peer.call(pid, localStream);
    mediaCalls[pid]=call;
    call.on('stream', s=>createRemoteVideo(pid,s));
    call.on('close', ()=>{ delete mediaCalls[pid]; removeRemoteVideo(pid); });
    addLocalVideo();
  }catch(e){ alert('Error cámara: '+e); }
}

peer.on('call', async call=>{
  const accept = confirm(call.peer.replace('chat-','')+' quiere iniciar cámara. Aceptas?');
  if(!accept){ call.close(); return; }
  if(!localStream) localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  call.answer(localStream);
  mediaCalls[call.peer]=call;
  call.on('stream', s=>createRemoteVideo(call.peer,s));
  call.on('close', ()=>{ delete mediaCalls[call.peer]; removeRemoteVideo(call.peer); });
  addLocalVideo();
});

function addLocalVideo(){
  const existing = document.getElementById('localVideoContainer'); if(existing) existing.remove();
  const cont=document.createElement('div'); cont.id='localVideoContainer'; cont.className='video-container';
  const v=document.createElement('video'); v.autoplay=true; v.muted=true; v.srcObject=localStream;
  cont.appendChild(v);
  const label=document.createElement('div'); label.className='video-label'; label.textContent='Tú';
  cont.appendChild(label); videosDiv.prepend(cont);
}

function createRemoteVideo(pid, stream){
  if(document.getElementById('video-'+pid)) return;
  const cont=document.createElement('div'); cont.className='video-container'; cont.id='video-'+pid;
  const v=document.createElement('video'); v.autoplay=true; v.srcObject=stream;
  cont.appendChild(v);
  const label=document.createElement('div'); label.className='video-label'; label.textContent=pid.replace('chat-','');
  cont.appendChild(label);
  videosDiv.appendChild(cont);
}

function removeRemoteVideo(pid){ const el=document.getElementById('video-'+pid); if(el) el.remove(); delete mediaCalls[pid]; }

// -------------------- ADMIN --------------------
document.getElementById('closeAdmin').onclick=()=>{ adminPanel.style.display='none'; };
document.getElementById('kickBtn').onclick=()=>{ const t=prompt('Kick ID:'); if(t && dataConns['chat-'+t]){ dataConns['chat-'+t].close(); } };
document.getElementById('banBtn').onclick=()=>{ const t=prompt('Ban ID:'); if(t){ dataConns['chat-'+t]?.send({type:'ban'}); dataConns['chat-'+t]?.close(); } };
document.getElementById('tempBanBtn').onclick=()=>{ const t=prompt('TempBan ID:'); const m=parseInt(prompt('Minutos?'))||5; if(t){ dataConns['chat-'+t]?.send({type:'ban'}); dataConns['chat-'+t]?.close(); setTimeout(()=>{}, m*60000); } };
document.getElementById('tempBanIPBtn').onclick=()=>{ const t=prompt('TempBanIP ID:'); if(t){ dataConns['chat-'+t]?.send({type:'ban'}); dataConns['chat-'+t]?.close(); localStorage.setItem('banIP-'+t,'true'); alert(t+' bloqueado por IP'); } };

// Bloqueo IP al cargar
for(const k in dataConns){ if(localStorage.getItem('banIP-'+k)){ alert('Bloqueado por IP: '+k); throw new Error('Bloqueado'); } }

peer.on('connection', conn=>{ setupConn(conn); });
peer.on('open', id=>{ addMessage('Conectado como '+id,'msg-me'); });

</script>
</body>
</html>
