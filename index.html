<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Chat P2P con Votaciones, Kick/Ban y Videollamada Grupal</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      margin: 0;
      height: 100vh;
    }
    #sidebar {
      width: 200px;
      background: #2c3e50;
      color: white;
      display: flex;
      flex-direction: column;
      padding: 10px;
      box-sizing: border-box;
    }
    #sidebar h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
    }
    #userList {
      flex: 1;
      overflow-y: auto;
    }
    .user-entry {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .user-entry button {
      background: #34495e;
      border: none;
      color: white;
      font-size: 12px;
      cursor: pointer;
      margin-left: 2px;
    }
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #ecf0f1;
    }
    #videos {
      display: flex;
      flex-wrap: wrap;
      background: #bdc3c7;
      padding: 5px;
    }
    .video-container {
      position: relative;
      margin: 5px;
    }
    .video-label {
      position: absolute;
      bottom: 2px;
      left: 2px;
      background: rgba(0,0,0,0.5);
      color: white;
      font-size: 12px;
      padding: 2px 4px;
      border-radius: 3px;
    }
    #chat {
      flex: 1;
      overflow-y: auto;
      background: white;
      padding: 10px;
      border-top: 1px solid #ccc;
      border-bottom: 1px solid #ccc;
    }
    #controls {
      display: flex;
      padding: 5px;
      background: #fff;
    }
    #controls input {
      flex: 1;
      padding: 5px;
    }
    #controls button {
      margin-left: 5px;
    }
    #votePanel {
      background: #ffeaa7;
      padding: 5px;
      display: none;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h3>Usuarios en l√≠nea</h3>
    <div id="userList"></div>
    <button id="adminModeBtn">Modo Admin</button>
  </div>
  <div id="main">
    <div id="videos"></div>
    <div id="chat"></div>
    <div id="votePanel"></div>
    <div id="controls">
      <input type="text" id="msgInput" placeholder="Escribe un mensaje...">
      <button id="sendBtn">Enviar</button>
      <input type="file" id="fileInput" style="display:none">
      <button id="sendFileBtn">üìÅ</button>
    </div>
  </div>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    const PASSWORD = "0011";
    const userName = prompt("Pon tu nombre:") || "user" + Math.floor(Math.random()*1000);
    const myId = `chat-${userName}`;

    const peer = new Peer(myId);
    const connections = {};
    const onlineUsers = new Set();
    let isAdmin = false;
    let localStream = null;
    const activeCalls = {};
    const remoteVideos = {};

    const chatDiv = document.getElementById("chat");
    const userListDiv = document.getElementById("userList");
    const votePanel = document.getElementById("votePanel");

    function addMessage(msg){
      const p = document.createElement("p");
      p.textContent = msg;
      chatDiv.appendChild(p);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    function refreshUserList(){
      userListDiv.innerHTML = "";
      onlineUsers.forEach(id=>{
        const row = document.createElement("div");
        row.className = "user-entry";
        row.textContent = id.replace("chat-", "");
        if(id!==myId){
          const btnChat = document.createElement("button");
          btnChat.textContent="üí¨";
          btnChat.onclick=()=>connectToUser(id);
          const btnCall = document.createElement("button");
          btnCall.textContent="üìπ";
          btnCall.onclick=()=>startCall(id);
          row.appendChild(btnChat);
          row.appendChild(btnCall);
          const btnKick = document.createElement("button");
          btnKick.textContent = "‚ùå";
          btnKick.onclick=()=>handleKickVote(id);
          row.appendChild(btnKick);
        }
        userListDiv.appendChild(row);
      });
    }

    function broadcast(msg){
      for(const id in connections){
        connections[id].send(msg);
      }
    }

    function connectToUser(friendId){
      if(connections[friendId]) return;
      const conn = peer.connect(friendId);
      conn.on("open", ()=>setupConnection(conn));
    }

    function setupConnection(conn){
      connections[conn.peer] = conn;
      onlineUsers.add(conn.peer);
      refreshUserList();
      conn.on("data", data=>handleData(conn.peer,data));
      conn.on("close", ()=>{
        delete connections[conn.peer];
        onlineUsers.delete(conn.peer);
        refreshUserList();
        removeRemoteVideo(conn.peer);
      });
      conn.send({type:"join",id:myId,name:userName});
    }

    peer.on("connection",setupConnection);
    peer.on("open",()=>{
      onlineUsers.add(myId);
      refreshUserList();
    });

    function handleData(peerId,data){
      if(data.type==="join"){
        onlineUsers.add(data.id);
        refreshUserList();
      }else if(data.type==="leave"){
        onlineUsers.delete(data.id);
        refreshUserList();
      }else if(data.type==="msg"){
        addMessage(`${data.name}: ${data.text}`);
      }else if(data.type==="clearChatVote"){
        showVotePanel("Borrar conversaci√≥n?",()=>{
          sendVoteResult("clearChatVote",peerId,true);
        },()=>{
          sendVoteResult("clearChatVote",peerId,false);
        });
      }else if(data.type==="clearChatResult" && data.result){
        chatDiv.innerHTML="";
        addMessage("üóë Chat borrado por mayor√≠a");
      }else if(data.type==="kick" && data.target===myId){
        addMessage("Has sido expulsado.");
        setTimeout(()=>location.reload(),500);
      }
    }

    function showVotePanel(question,onYes,onNo){
      votePanel.innerHTML=`<strong>${question}</strong><button id='yesBtn'>S√≠</button><button id='noBtn'>No</button>`;
      votePanel.style.display="block";
      document.getElementById("yesBtn").onclick=()=>{onYes();votePanel.style.display="none";};
      document.getElementById("noBtn").onclick=()=>{onNo();votePanel.style.display="none";};
    }

    function sendVoteResult(type,peerId,value){
      connections[peerId]?.send({type:type+"Result",voter:myId,result:value});
    }

    function handleKickVote(target){
      if(isAdmin){
        broadcast({type:"kick",target});
      }else{
        showVotePanel(`Expulsar a ${target.replace('chat-','')}?`,()=>broadcast({type:"kickVote",target,vote:true}),()=>broadcast({type:"kickVote",target,vote:false}));
      }
    }

    document.getElementById("sendBtn").onclick=()=>{
      const text=document.getElementById("msgInput").value.trim();
      if(!text) return;
      addMessage(`T√∫: ${text}`);
      broadcast({type:"msg",name:userName,text});
      document.getElementById("msgInput").value="";
    };

    document.getElementById("sendFileBtn").onclick=()=>document.getElementById("fileInput").click();

    document.getElementById("adminModeBtn").onclick=()=>{
      const pwd=prompt("Contrase√±a de admin:");
      if(pwd===PASSWORD){
        isAdmin=true;
        addMessage("Modo admin activado. Tus votos cuentan doble.");
      }else{
        alert("Contrase√±a incorrecta");
      }
    };

    async function startCall(friendId){
      if(!localStream){
        try{
          localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
          createLocalVideo();
        }catch(e){alert("No se pudo acceder a la c√°mara");return;}
      }
      const call=peer.call(friendId,localStream);
      activeCalls[friendId]=call;
      call.on("stream",stream=>createRemoteVideo(friendId,stream));
      call.on("close",()=>removeRemoteVideo(friendId));
    }

    peer.on("call",async call=>{
      if(!localStream){
        localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
        createLocalVideo();
      }
      call.answer(localStream);
      activeCalls[call.peer]=call;
      call.on("stream",stream=>createRemoteVideo(call.peer,stream));
      call.on("close",()=>removeRemoteVideo(call.peer));
    });

    function createLocalVideo(){
      const c=document.createElement("div");
      c.className="video-container";
      const v=document.createElement("video");
      v.autoplay=true;
      v.muted=true;
      v.srcObject=localStream;
      const label=document.createElement("div");
      label.className="video-label";
      label.textContent="T√∫";
      c.appendChild(v);
      c.appendChild(label);
      document.getElementById("videos").appendChild(c);
    }

    function createRemoteVideo(id,stream){
      if(remoteVideos[id]) return;
      const c=document.createElement("div");
      c.className="video-container";
      const v=document.createElement("video");
      v.autoplay=true;
      v.srcObject=stream;
      const label=document.createElement("div");
      label.className="video-label";
      label.textContent=id.replace("chat-","");
      c.appendChild(v);
      c.appendChild(label);
      document.getElementById("videos").appendChild(c);
      remoteVideos[id]=c;
    }

    function removeRemoteVideo(id){
      if(remoteVideos[id]){
        remoteVideos[id].remove();
        delete remoteVideos[id];
      }
    }
  </script>
</body>
</html>
