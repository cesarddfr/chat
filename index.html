<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Chat P2P por ID</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body, html{margin:0;padding:0;font-family:sans-serif;height:100%}
.app{display:flex;height:100%}
.sidebar{width:300px;padding:12px;background:#f0f0f0;box-sizing:border-box;display:flex;flex-direction:column}
.main{flex:1;display:flex;flex-direction:column;padding:12px;box-sizing:border-box}
#messages{flex:1;overflow:auto;padding:8px;border:1px solid #ccc;margin-bottom:8px;height:400px}
.message{margin:4px 0;padding:6px 8px;border-radius:6px}
.msg-me{background:#d0f0ff;align-self:flex-end}
.msg-other{background:#f0f0f0;align-self:flex-start}
.controls{display:flex;gap:4px}
input[type=text]{flex:1;padding:6px;border-radius:4px;border:1px solid #ccc}
button{padding:6px 8px;border-radius:4px;border:none;background:#007bff;color:white;cursor:pointer}
button.small{padding:4px 6px;font-size:12px}
#videos{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.video-container{position:relative;width:240px;height:180px;background:black;border-radius:6px;overflow:hidden;display:flex;align-items:center;justify-content:center}
.video-container video{width:100%;height:100%;object-fit:cover}
.video-label{position:absolute;bottom:4px;left:4px;background:rgba(0,0,0,0.5);color:white;padding:2px 4px;border-radius:4px;font-size:12px}
</style>
</head>
<body>
<div class="app">
  <div class="sidebar">
    <h3>Conectar a un usuario</h3>
    <input id="peerIdInput" placeholder="ID del peer">
    <button id="connectBtn">Conectar</button>
    <div style="margin-top:12px"><strong>Tu ID:</strong> <span id="meId"></span></div>
  </div>
  <div class="main">
    <div id="messages"></div>
    <div class="controls">
      <input id="messageInput" placeholder="Escribe un mensaje">
      <button id="sendBtn">Enviar</button>
      <label class="btn small">📁<input type="file" id="fileInput" style="display:none"></label>
    </div>
    <div id="videos"></div>
    <div style="margin-top:8px">
      <button id="startCam" class="small">Iniciar cámara</button>
      <button id="stopCam" class="small">Detener cámara</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
const userName = prompt('Tu nombre:') || 'user'+Math.floor(Math.random()*1000);
const myId = 'chat-'+userName;
const meIdSpan = document.getElementById('meId');
meIdSpan.textContent = myId;

const peer = new Peer(myId);
const dataConns = {}, mediaCalls = {};
let localStream = null;

const messagesDiv = document.getElementById('messages');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const fileInput = document.getElementById('fileInput');

const peerIdInput = document.getElementById('peerIdInput');
const connectBtn = document.getElementById('connectBtn');

const videosDiv = document.getElementById('videos');
const startCamBtn = document.getElementById('startCam');
const stopCamBtn = document.getElementById('stopCam');

function addMessage(text, cls='msg-other'){
  const div = document.createElement('div');
  div.className = 'message '+cls;
  div.textContent = text;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Conectar a un peer por ID
connectBtn.onclick = ()=>{
  const target = peerIdInput.value.trim();
  if(!target || target===myId){ alert('ID inválido'); return; }
  if(dataConns[target]){ alert('Ya conectado'); return; }
  const conn = peer.connect(target, {reliable:true});
  conn.on('open', ()=>setupConn(conn));
  conn.on('error', e=>alert('Error de conexión: '+e));
};

// Configuración de la conexión de datos
function setupConn(conn){
  dataConns[conn.peer] = conn;
  addMessage(`🔗 Conectado a ${conn.peer}`, 'msg-me');
  conn.on('data', data=>handleData(conn.peer,data));
  conn.on('close', ()=>{
    addMessage(`⚠️ ${conn.peer} se desconectó`);
    delete dataConns[conn.peer];
  });
}

// Recibir conexiones entrantes
peer.on('connection', conn=>{ setupConn(conn); });

// Manejo de datos entrantes
function handleData(from, data){
  if(data.type==='chat'){ addMessage(`${data.name}: ${data.text}`,'msg-other'); }
  else if(data.type==='file'){
    const a=document.createElement('a'); a.href=data.url; a.download=data.fileName; a.textContent=`📎 ${data.name} envió ${data.fileName}`;
    const div=document.createElement('div'); div.className='message msg-other'; div.appendChild(a); messagesDiv.appendChild(div);
  }
}

// Enviar mensaje
sendBtn.onclick = ()=>{
  const text = messageInput.value.trim();
  if(!text) return;
  for(const k in dataConns){ try{ dataConns[k].send({type:'chat',name:userName,text}); }catch(e){} }
  addMessage('Tú: '+text,'msg-me');
  messageInput.value='';
};

// Enviar archivo
fileInput.addEventListener('change', ()=>{
  const f = fileInput.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    const url = URL.createObjectURL(new Blob([reader.result]));
    for(const k in dataConns){ try{ dataConns[k].send({type:'file',name:userName,fileName:f.name,url}); }catch(e){} }
    addMessage('📎 Enviaste: '+f.name,'msg-me');
  };
  reader.readAsArrayBuffer(f);
  fileInput.value='';
});

// Videollamada
async function ensureLocalStream(){ 
  if(localStream) return localStream;
  localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  const localVideo = document.createElement('video');
  localVideo.autoplay = true; localVideo.muted=true; localVideo.srcObject=localStream;
  const cont=document.createElement('div'); cont.className='video-container'; cont.id='localVideoContainer'; cont.appendChild(localVideo);
  const label = document.createElement('div'); label.className='video-label'; label.textContent='Tú'; cont.appendChild(label);
  videosDiv.prepend(cont);
  return localStream;
}

async function startCall(pid){ await ensureLocalStream(); try{
  const call = peer.call(pid, localStream); mediaCalls[pid]=call;
  call.on('stream', s=>{
    const cont=document.createElement('div'); cont.className='video-container'; cont.id='video-'+pid;
    const v=document.createElement('video'); v.autoplay=true; v.srcObject=s; cont.appendChild(v);
    const label=document.createElement('div'); label.className='video-label'; label.textContent=pid; cont.appendChild(label);
    videosDiv.appendChild(cont);
  });
  call.on('close', ()=>{ const el=document.getElementById('video-'+pid); if(el) el.remove(); delete mediaCalls[pid]; });
}catch(e){console.warn(e);} }

peer.on('call', async call=>{ await ensureLocalStream(); call.answer(localStream);
  mediaCalls[call.peer]=call;
  call.on('stream', s=>{
    const cont=document.createElement('div'); cont.className='video-container'; cont.id='video-'+call.peer;
    const v=document.createElement('video'); v.autoplay=true; v.srcObject=s; cont.appendChild(v);
    const label=document.createElement('div'); label.className='video-label'; label.textContent=call.peer; cont.appendChild(label);
    videosDiv.appendChild(cont);
  });
  call.on('close', ()=>{ const el=document.getElementById('video-'+call.peer); if(el) el.remove(); delete mediaCalls[call.peer]; });
});

startCamBtn.onclick = ()=>ensureLocalStream();
stopCamBtn.onclick = ()=>{ if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; const el=document.getElementById('localVideoContainer'); if(el) el.remove(); } };
</script>
</body>
</html>
